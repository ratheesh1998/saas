{% load crispy_forms_tags %}

{% if template_id %}
<script>
    window.templateIdFromContext = {{ template_id }};
</script>
{% endif %}

<div id="template-editor-full" class="template-editor-full">
    <!-- Architecture Tab Content (Grid Only) -->
    <div id="architecture-tab" class="tab-content">
        <!-- Services Canvas Container -->
        <div class="services-canvas-wrapper">
            <!-- Add Button (Top Right) -->
            <div class="add-button-container">
                <button 
                    type="button" 
                    class="btn btn-dark text-white"
                    onclick="addServiceCard()">
                    <i class="bi bi-plus-circle me-1"></i> ADD NEW
                </button>
            </div>
            
            <!-- Services Grid Canvas -->
            <div id="services-canvas" class="services-canvas">
                <!-- Service cards will be added here dynamically -->
            </div>
        </div>
        
        <!-- Off-Canvas Panel for Service Details -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="service-offcanvas" aria-labelledby="service-offcanvas-label" data-bs-backdrop="true" data-bs-scroll="true">
            <div class="offcanvas-header border-bottom">
                <div class="d-flex align-items-center flex-grow-1">
                    <i class="bi bi-box service-offcanvas-icon me-3" id="offcanvas-service-icon" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                            <input 
                                type="text" 
                                class="offcanvas-title-input" 
                                id="offcanvas-service-name-input" 
                                value="Service Name"
                                placeholder="Enter service name"
                                onchange="updateServiceName(this.value)"
                                onkeypress="if(event.key === 'Enter') { this.blur(); updateServiceName(this.value); }"
                                onfocus="this.classList.add('editing')"
                                onblur="this.classList.remove('editing'); updateServiceName(this.value);">
                    </div>
                </div>
                <button type="button" class="btn-close ms-3" data-bs-dismiss="offcanvas" aria-label="Close" onclick="if(typeof hideOffcanvasFallback === 'function') { hideOffcanvasFallback(); } else if(typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) { const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('service-offcanvas')); if(offcanvas) offcanvas.hide(); }"></button>
            </div>
            <div class="offcanvas-body p-0">
                <!-- Service Tabs -->
                <ul class="nav nav-tabs border-bottom px-4 pt-3" id="service-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">
                            Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="variables-tab" data-bs-toggle="tab" data-bs-target="#variables-pane" type="button" role="tab">
                            Variables
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab-btn" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                            Settings
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="service-tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active px-4 py-4" id="overview-pane" role="tabpanel">
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-code-square me-2"></i> Source</h6>
                            <div class="card" style="background-color: var(--gray-50, #fafafa); border: 1px solid var(--gray-200, #e5e5e5);">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-box me-3" style="font-size: 1.75rem; color: var(--gray-600);"></i>
                                            <div>
                                                <div class="fw-bold mb-1" id="offcanvas-service-name" style="font-size: 1rem;">Service Name</div>
                                                <small class="text-muted" id="offcanvas-service-image">No image</small>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editServiceSource()">
                                            <i class="bi bi-pencil me-1"></i> Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-slash-circle me-2"></i> Environment Variables</h6>
                            <div id="offcanvas-variables-list" class="mb-3">
                                <p class="text-muted mb-0">No variables added to this service.</p>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addVariable()">
                                <i class="bi bi-plus-circle me-1"></i> Add variables
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-gear me-2"></i> Service Settings</h6>
                            <p class="text-muted mb-3">No settings have been configured for this service.</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="showSettingsTab()">
                                <i class="bi bi-pencil me-1"></i> Edit settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Variables Tab -->
                    <div class="tab-pane fade px-4 py-4" id="variables-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 fw-semibold">Service Variables</h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="toggleRawEditor()">
                                    <i class="bi bi-code me-1"></i> Raw Editor
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addVariable()">
                                    <i class="bi bi-plus-circle me-1"></i> New Variable
                                </button>
                            </div>
                        </div>
                        <div id="variables-editor">
                            <div id="variables-list-container">
                                <!-- Variables will be added here -->
                            </div>
                        </div>
                        <div id="raw-editor-container" style="display: none;">
                            <textarea class="form-control font-monospace" rows="10" id="raw-variables-editor" placeholder='{"KEY": "value"}'></textarea>
                            <button type="button" class="btn btn-primary btn-sm mt-2" onclick="saveRawVariables()">Save</button>
                        </div>
                    </div>
                    
                    <!-- Settings Tab - Single Scrollable Page -->
                    <div class="tab-pane fade" id="settings-pane" role="tabpanel">
                        <div class="settings-single-page">
                            <!-- Search/Filter Bar -->
                            <div class="settings-filter-bar px-4 py-3 border-bottom bg-white sticky-top">
                                <input type="text" class="form-control" placeholder="Filter Settings..." id="settings-filter">
                            </div>
                            
                            <!-- Scrollable Content -->
                            <div class="settings-scroll-content px-4 py-4">
                                <!-- Source Section -->
                                <div class="settings-section-block mb-5" id="settings-source">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="settings-icon-wrapper">
                                            <i class="bi bi-code-square settings-section-icon"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">Source</h5>
                                        </div>
                                    </div>
                                    <div class="settings-section-content">
                                        <div class="mb-4">
                                            <label class="form-label fw-medium mb-2">Source Image</label>
                                            <input type="text" class="form-control" id="service-source-image" placeholder="e.g., horillaadmin/horilla-cloud:latest" oninput="debounceValidateImage()">
                                            <small class="form-text text-muted mt-2 d-block">Docker image or container registry URL</small>
                                            <div id="image-validation-result" class="mt-2"></div>
                                        </div>
                                        
                                        <!-- Registry Credentials Section -->
                                        <div class="registry-credentials-section">
                                            <h6 class="fw-semibold mb-3">Registry Credentials</h6>
                                            <p class="text-muted small mb-3">Private Docker Registry credentials used to deploy your Docker image.</p>
                                            
                                            <!-- Credentials Form (Initially Hidden) -->
                                            <div id="credentials-form" class="credentials-form" style="display: none;">
                                                <div class="mb-3">
                                                    <label class="form-label fw-medium mb-2">Username</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="registry-username" placeholder="Enter registry username">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('registry-username')">
                                                            <i class="bi bi-eye-slash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label fw-medium mb-2">Password</label>
                                                    <div class="input-group">
                                                        <input type="password" class="form-control" id="registry-password" placeholder="Enter registry password">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('registry-password')">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex gap-2">
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="saveCredentials()">
                                                        Set credentials
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleCredentialsForm()">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Add Credentials Button -->
                                            <div id="add-credentials-btn-wrapper">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleCredentialsForm()">
                                                    <i class="bi bi-plus me-1"></i> Add credentials
                                                </button>
                                            </div>
                                            
                                            <!-- Credentials Info Box (shown when credentials exist) -->
                                            <div id="credentials-info" class="alert alert-info d-flex align-items-center justify-content-between" style="display: none !important;">
                                                <div>
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <span>Registry credentials configured</span>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-link text-primary" onclick="toggleCredentialsForm()">
                                                    Edit
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Networking Section -->
                                <div class="settings-section-block mb-5" id="settings-networking">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="settings-icon-wrapper">
                                            <i class="bi bi-diagram-3 settings-section-icon"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">Networking</h5>
                                        </div>
                                    </div>
                                    <div class="settings-section-content">
                                        <h6 class="fw-semibold mb-3">Public Networking</h6>
                                        <p class="text-muted mb-3">Access your application over HTTP with the following domains</p>
                                        
                                        <div class="networking-items mb-3">
                                            <div class="networking-item border rounded p-3 mb-2">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center">
                                                        <i class="bi bi-globe me-2"></i>
                                                        <span class="text-muted small">No domains configured</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addHttpProxy()">
                                            <i class="bi bi-plus me-1"></i> Custom Domain
                                        </button>
                                        
                                        <div class="mt-4">
                                            <p class="text-muted mb-3">Connect to your service over TCP using a proxied domain and port</p>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTcpProxy()">
                                                <i class="bi bi-plus me-1"></i> TCP Proxy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Build Section -->
                                <div class="settings-section-block mb-5" id="settings-build">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="settings-icon-wrapper">
                                            <i class="bi bi-hammer settings-section-icon"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">Build</h5>
                                        </div>
                                    </div>
                                    <div class="settings-section-content">
                                        <p class="text-muted">No build configuration needed for this service.</p>
                                    </div>
                                </div>
                                
                                <!-- Deploy Section -->
                                <div class="settings-section-block mb-5" id="settings-deploy">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="settings-icon-wrapper">
                                            <i class="bi bi-rocket settings-section-icon"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">Deploy</h5>
                                        </div>
                                    </div>
                                    <div class="settings-section-content">
                                        <h6 class="fw-semibold mb-3">Resource Limits</h6>
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-6">
                                                <label class="form-label fw-medium mb-2">CPU (vCPU)</label>
                                                <input type="number" class="form-control" id="service-cpu" value="8" min="1" max="32" onchange="autoSaveService()" onkeypress="if(event.key === 'Enter') { this.blur(); autoSaveService(); }">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-medium mb-2">Memory (GB)</label>
                                                <input type="number" class="form-control" id="service-memory" value="8" min="1" max="32" onchange="autoSaveService()" onkeypress="if(event.key === 'Enter') { this.blur(); autoSaveService(); }">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Danger Section -->
                                <div class="settings-section-block mb-5 last-section" id="settings-danger">
                                    <div class="d-flex align-items-start mb-3">
                                        <div class="settings-icon-wrapper">
                                            <i class="bi bi-exclamation-triangle text-danger settings-section-icon"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0 text-danger">Danger</h5>
                                        </div>
                                    </div>
                                    <div class="settings-section-content">
                                        <div class="border border-danger rounded p-4">
                                            <h6 class="fw-semibold mb-2">Delete Service</h6>
                                            <p class="text-muted mb-3">Deleting this service will permanently delete all its deployments and remove it from this environment. This cannot be undone.</p>
                                            <button type="button" class="btn btn-danger" onclick="if(confirm('Are you sure you want to delete this service?')) { removeServiceCard(currentServiceId, event); if(typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) { const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('service-offcanvas')); if(offcanvas) offcanvas.hide(); } }">
                                                Delete service
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Tab Content -->
    <div id="settings-tab" class="tab-content" style="display: {% if template_action == 'settings' %}block{% else %}none{% endif %};">
        <div class="row g-0">
            <!-- Settings Sidebar -->
            <div class="col-md-3 border-end bg-light" style="min-height: 400px;">
                <div class="p-3">
                    <ul class="nav nav-pills flex-column" role="tablist">
                        <li class="nav-item mb-2">
                            <button 
                                class="nav-link w-100 text-start active" 
                                type="button"
                                onclick="showSettingsSection('general')">
                                <i class="bi bi-gear me-2"></i> General
                            </button>
                        </li>
                        <li class="nav-item mb-2">
                            <button 
                                class="nav-link w-100 text-start" 
                                type="button"
                                onclick="showSettingsSection('danger')">
                                <i class="bi bi-trash me-2"></i> Danger
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="col-md-9">
                <div class="p-4">
                    <!-- General Section -->
                    <div id="settings-general" class="settings-section">
                        <h5 class="mb-4">Basic Info</h5>
                        
                        <div class="mb-3">
                            <label for="template-name" class="form-label">Name</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="template-name" 
                                placeholder="Enter template name" 
                                required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="template-icon" class="form-label">Icon</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="template-icon" 
                                placeholder="https://devicons.railway.com/i/bun.svg">
                            <small class="form-text text-muted">Icon URL for the template</small>
                        </div>
                        
                        <div class="mb-4">
                            <label for="template-description" class="form-label">Description</label>
                            <textarea 
                                class="form-control" 
                                id="template-description" 
                                rows="4"
                                placeholder="Enter template description"></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button 
                                type="button" 
                                class="btn btn-primary"
                                onclick="saveTemplate()">
                                <i class="bi bi-save me-1"></i> Create Template
                            </button>
                            <button 
                                type="button" 
                                class="btn btn-outline-secondary"
                                onclick="updateTemplateInfo()">
                                Update Info
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danger Section -->
                    <div id="settings-danger" class="settings-section" style="display: none;">
                        <h5 class="mb-4 text-danger">Danger Zone</h5>
                        <div class="card border-danger">
                            <div class="card-body">
                                <h6 class="card-title">Delete Template</h6>
                                <p class="card-text text-muted">Once you delete a template, there is no going back. Please be certain.</p>
                                <button type="button" class="btn btn-danger">
                                    Delete Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden form for submission -->
    <form id="template-form" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="template">
        <input type="hidden" name="name" id="form-template-name">
        <input type="hidden" name="description" id="form-template-description">
        <input type="hidden" name="template_config" id="form-template-config">
    </form>
</div>

<script>
// Initialize services object and counter immediately - make them global
// Use window assignments to avoid redeclaration errors on HTMX swaps
if (typeof window.serviceCounter === 'undefined') {
    window.serviceCounter = 0;
}
if (typeof window.services === 'undefined') {
    window.services = {};
}
if (typeof window.cardDragData === 'undefined') {
    window.cardDragData = new Map();
}

let serviceCounter = window.serviceCounter;
let services = window.services;
let cardDragData = window.cardDragData;

let draggedElement = null;
let dragOffset = { x: 0, y: 0 };
let dragStartPos = { x: 0, y: 0 };
let isDragging = false;
let dragThreshold = 5; // pixels to move before drag starts

// Get template ID from URL or Django context
let templateId = null;

// Try URL params first
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('template_id')) {
    templateId = urlParams.get('template_id');
}

// If not in URL, check if it's in the template context
if (!templateId && typeof window.templateIdFromContext !== 'undefined') {
    templateId = window.templateIdFromContext;
}

console.log('Template ID:', templateId);


// Handle card click - define early so it's available globally
function handleCardClick(serviceId, event) {
    console.log('handleCardClick called for:', serviceId);
    
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // Check if we were dragging
    const cardElement = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (cardElement && cardDragData) {
        const dragData = cardDragData.get(cardElement);
        // Only prevent if we actually dragged
        if (dragData && dragData.hasMoved) {
            console.log('Click ignored - card was dragged');
            dragData.hasMoved = false;
            return;
        }
    }
    
    // Open the service details - check if function exists
    if (typeof openServiceDetails === 'function') {
        console.log('Calling openServiceDetails');
        openServiceDetails(serviceId);
    } else {
        console.error('openServiceDetails function not found');
        // Fallback - try to call it later
        setTimeout(() => {
            if (typeof openServiceDetails === 'function') {
                openServiceDetails(serviceId);
            } else {
                console.error('openServiceDetails still not available');
            }
        }, 100);
    }
}

// Make it globally available immediately
window.handleCardClick = handleCardClick;

function showTab(tabName) {
    // Hide all tabs
    document.getElementById('architecture-tab').style.display = 'none';
    document.getElementById('settings-tab').style.display = 'none';
    
    // Show selected tab
    if (tabName === 'architecture') {
        document.getElementById('architecture-tab').style.display = 'block';
    } else if (tabName === 'settings') {
        document.getElementById('settings-tab').style.display = 'block';
    }
    
    // Update active tab button
    document.querySelectorAll('.btn-link').forEach(btn => {
        const btnText = btn.textContent.trim();
        if (btnText === 'Architecture' || btnText === 'Settings') {
            if ((tabName === 'architecture' && btnText === 'Architecture') ||
                (tabName === 'settings' && btnText === 'Settings')) {
                btn.style.borderBottomColor = '#000';
            } else {
                btn.style.borderBottomColor = 'transparent';
            }
        }
    });
}

function showSettingsSection(section) {
    // Hide all sections
    document.querySelectorAll('.settings-section').forEach(sec => {
        sec.style.display = 'none';
    });
    
    // Show selected section
    const selectedSection = document.getElementById('settings-' + section);
    if (selectedSection) {
        selectedSection.style.display = 'block';
    }
    
    // Update active sidebar item
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`.settings-nav-item[data-section="${section}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

function updateTemplateInfo() {
    // This function can be used to update template info without saving the whole template
    const name = document.getElementById('template-name').value;
    const description = document.getElementById('template-description').value;
    const icon = document.getElementById('template-icon').value;
    
    if (!name) {
        alert('Template name is required!');
        return;
    }
    
    // Show success message
    alert('Template information updated!');
}

let currentServiceId = null;
let autoSaveTimeout = null;

// Function to save service to backend
async function saveServiceToBackend(serviceId) {
    if (!templateId) {
        console.warn('No template ID available');
        return;
    }
    
    const service = services[serviceId];
    if (!service) {
        console.error('Service not found:', serviceId);
        return;
    }
    
    try {
        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCookie('csrftoken');
        
        const response = await fetch('/service/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                template_id: templateId,
                service_id: serviceId,
                name: service.name,
                image: service.image,
                cpu: service.cpu,
                memory: service.memory,
                variables: service.variables,
                networking: service.networking,
                position: service.position
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log('Service saved:', data);
        } else {
            console.error('Error saving service:', data.error);
        }
    } catch (error) {
        console.error('Error saving service:', error);
    }
}

// Helper function to get cookie (for CSRF token)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addServiceCard() {
    console.log('addServiceCard called');
    const canvas = document.getElementById('services-canvas');
    const emptyState = document.getElementById('empty-state');
    
    if (!canvas) {
        console.error('Canvas not found!');
        alert('Canvas not found. Please refresh the page.');
        return;
    }
    
    // Use global counter and services
    serviceCounter = (serviceCounter || 0) + 1;
    window.serviceCounter = serviceCounter;
    
    // Ensure services object exists and is synced with window
    if (!services) {
        services = {};
    }
    if (!window.services) {
        window.services = services;
    } else {
        services = window.services; // Use global services object
    }
    
    const serviceId = `service_${serviceCounter}`;
    
    // Hide empty state
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    // Create service object
    const initialX = Math.random() * 300 + 50;
    const initialY = Math.random() * 200 + 100;
    
    services[serviceId] = {
        id: serviceId,
        name: 'New Service',
        image: '',
        cpu: 8,
        memory: 8,
        variables: {},
        networking: {
            http: false,
            tcp: false
        },
        position: {
            x: initialX,
            y: initialY
        }
    };
    
    // Sync with window
    window.services = services;
    
    console.log('Service added:', serviceId, services[serviceId]);
    console.log('Total services:', Object.keys(services).length);
    
    // Create service card HTML (Railway style)
    const service = services[serviceId];
    const cardHtml = `
        <div class="service-card railway-card" 
             data-service-id="${serviceId}"
             style="left: ${service.position.x}px; top: ${service.position.y}px;">
            <button 
                type="button" 
                class="btn btn-sm btn-link text-danger p-0 btn-remove"
                onclick="removeServiceCard('${serviceId}', event)"
                title="Remove service">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="service-card-content" onclick="handleCardClick('${serviceId}', event)">
                <div class="service-card-icon-wrapper">
                    <i class="bi bi-box service-card-icon"></i>
                </div>
                <div class="service-card-info">
                    <div class="service-card-name">New Service</div>
                    <div class="service-card-subtitle">No image</div>
                </div>
                <div class="service-card-badge">
                    <i class="bi bi-list-ul"></i>
                    <span>No config required</span>
                </div>
            </div>
        </div>
    `;
    
    canvas.insertAdjacentHTML('beforeend', cardHtml);
    
    // Make card draggable
    const cardElement = canvas.querySelector(`[data-service-id="${serviceId}"]`);
    if (cardElement && typeof makeCardDraggable === 'function') {
        makeCardDraggable(cardElement, serviceId);
        console.log('Card made draggable:', serviceId);
    }
    
    if (typeof updateEmptyState === 'function') {
        updateEmptyState();
    }
    
    // Save service to backend
    saveServiceToBackend(serviceId);
}

// Make globally accessible immediately
window.addServiceCard = addServiceCard;

function openServiceDetails(serviceId) {
    // Prevent multiple simultaneous calls
    if (isDragging) {
        return;
    }
    
    // Prevent duplicate calls
    if (currentServiceId === serviceId && document.getElementById('service-offcanvas')?.classList.contains('show')) {
        return;
    }
    
    currentServiceId = serviceId;
    const service = services[serviceId];
    
    if (!service) {
        console.error('Service not found:', serviceId);
        return;
    }
    
    // Update offcanvas header
    const nameInput = document.getElementById('offcanvas-service-name-input');
    if (nameInput) {
        nameInput.value = service.name || 'New Service';
    }
    const imageEl = document.getElementById('offcanvas-service-image');
    if (imageEl) {
        imageEl.textContent = service.image || 'No image';
    }
    
    // Update form fields
    const sourceImage = document.getElementById('service-source-image');
    if (sourceImage) {
        sourceImage.value = service.image || '';
    }
    const cpuField = document.getElementById('service-cpu');
    if (cpuField) {
        cpuField.value = service.cpu || 8;
    }
    const memoryField = document.getElementById('service-memory');
    if (memoryField) {
        memoryField.value = service.memory || 8;
    }
    
    // Update credential fields and visibility
    const credentialsForm = document.getElementById('credentials-form');
    const credentialsInfo = document.getElementById('credentials-info');
    const addCredentialsBtn = document.getElementById('add-credentials-btn-wrapper');
    const usernameField = document.getElementById('registry-username');
    
    if (service.has_credentials) {
        // Has credentials - show info box, hide form and add button
        if (credentialsForm) credentialsForm.style.display = 'none';
        if (addCredentialsBtn) addCredentialsBtn.style.display = 'none';
        if (credentialsInfo) {
            credentialsInfo.style.display = 'flex';
            credentialsInfo.classList.remove('d-none');
        }
        // Populate username for editing
        if (usernameField && service.registry_username) {
            usernameField.value = service.registry_username;
        }
    } else {
        // No credentials - show add button, hide form and info
        if (credentialsForm) credentialsForm.style.display = 'none';
        if (credentialsInfo) credentialsInfo.style.display = 'none';
        if (addCredentialsBtn) addCredentialsBtn.style.display = 'block';
    }
    
    // Update variables list
    updateVariablesList();
    
    // Highlight selected card
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    const selectedCard = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    // Show offcanvas
    const offcanvasEl = document.getElementById('service-offcanvas');
    if (!offcanvasEl) {
        console.error('Offcanvas element not found - make sure the template editor is fully loaded');
        return;
    }
    
    console.log('Opening offcanvas for service:', serviceId, 'Element found:', !!offcanvasEl);
    
    // Function to show offcanvas
    function showOffcanvas() {
        console.log('showOffcanvas called');
        console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
        console.log('Bootstrap.Offcanvas available:', typeof bootstrap !== 'undefined' && typeof bootstrap.Offcanvas !== 'undefined');
        
        if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
            try {
                console.log('Using Bootstrap Offcanvas API');
                
                // Get or create offcanvas instance
                let offcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                if (!offcanvas) {
                    console.log('Creating new Offcanvas instance');
                    offcanvas = new bootstrap.Offcanvas(offcanvasEl, {
                        backdrop: true,
                        scroll: true
                    });
                }
                
                // Show it
                console.log('Calling offcanvas.show()');
                offcanvas.show();
                
                // Verify it's showing
                setTimeout(() => {
                    const isShowing = offcanvasEl.classList.contains('show');
                    console.log('Offcanvas showing:', isShowing);
                    if (!isShowing) {
                        console.error('Offcanvas failed to show, trying fallback');
                        showOffcanvasFallback();
                    }
                }, 200);
            } catch (e) {
                console.error('Error showing offcanvas with Bootstrap:', e);
                showOffcanvasFallback();
            }
        } else {
            console.log('Bootstrap not available, using fallback');
            showOffcanvasFallback();
        }
    }
    
    // Fallback method to show offcanvas manually
    function showOffcanvasFallback() {
        console.log('Using fallback method to show offcanvas');
        
        // Remove existing backdrop
        const existingBackdrop = document.querySelector('.offcanvas-backdrop');
        if (existingBackdrop) {
            existingBackdrop.remove();
        }
        
        // Get navbar height
        const navbar = document.querySelector('.navbar');
        const navbarHeight = navbar ? navbar.offsetHeight : 70;
        
        // Ensure offcanvas is positioned correctly
        offcanvasEl.style.position = 'fixed';
        offcanvasEl.style.top = navbarHeight + 'px';
        offcanvasEl.style.right = '0';
        offcanvasEl.style.bottom = 'auto';
        offcanvasEl.style.left = 'auto';
        offcanvasEl.style.width = '50%';
        offcanvasEl.style.maxWidth = 'none';
        offcanvasEl.style.height = `calc(100vh - ${navbarHeight}px)`;
        offcanvasEl.style.visibility = 'visible';
        offcanvasEl.style.display = 'block';
        offcanvasEl.style.zIndex = '1055';
        offcanvasEl.style.transition = 'transform 0.3s ease-in-out';
        
        // First set it off-screen
        offcanvasEl.style.transform = 'translateX(100%)';
        offcanvasEl.classList.remove('show');
        
        // Force reflow
        void offcanvasEl.offsetHeight;
        
        // Then animate it in
        setTimeout(() => {
            offcanvasEl.classList.add('show');
            offcanvasEl.style.transform = 'translateX(0)';
        }, 10);
        
        // Add body classes
        document.body.classList.add('modal-open', 'offcanvas-open');
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = '0px';
        
        // Add backdrop first
        const backdrop = document.createElement('div');
        backdrop.className = 'offcanvas-backdrop fade show';
        backdrop.style.position = 'fixed';
        backdrop.style.top = '0';
        backdrop.style.left = '0';
        backdrop.style.width = '100vw';
        backdrop.style.height = '100vh';
        backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        backdrop.style.zIndex = '1040';
        backdrop.style.transition = 'opacity 0.15s linear';
        backdrop.setAttribute('data-bs-backdrop', 'true');
        backdrop.addEventListener('click', function() {
            hideOffcanvasFallback();
        });
        document.body.appendChild(backdrop);
        
        // Force a reflow to ensure styles are applied
        offcanvasEl.offsetHeight;
        
        console.log('Fallback offcanvas should now be visible');
    }
    
    // Function to hide offcanvas (fallback)
    function hideOffcanvasFallback() {
        offcanvasEl.classList.remove('show');
        offcanvasEl.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
            offcanvasEl.style.display = 'none';
            document.body.classList.remove('modal-open', 'offcanvas-open');
            document.body.style.overflow = '';
            const backdrop = document.querySelector('.offcanvas-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }, 300); // Wait for transition
    }
    
    // Make hide function globally available for close button
    window.hideOffcanvasFallback = hideOffcanvasFallback;
    
    // Wait a bit for DOM to be ready, then show
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showOffcanvas);
    } else {
        // DOM is already ready
        setTimeout(showOffcanvas, 50);
    }
}

function updateServiceName(name) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    services[currentServiceId].name = name || 'New Service';
    
    // Update the offcanvas title
    const nameDisplay = document.getElementById('offcanvas-service-name');
    if (nameDisplay) {
        nameDisplay.textContent = services[currentServiceId].name;
    }
    
    // Update the card display
    updateServiceCardDisplay(currentServiceId);
    
    // Save to backend
    autoSaveService();
}

function autoSaveService() {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    const service = services[currentServiceId];
    
    // Update service data from form fields
    const imageInput = document.getElementById('service-source-image');
    const cpuInput = document.getElementById('service-cpu');
    const memoryInput = document.getElementById('service-memory');
    
    if (imageInput) {
        service.image = imageInput.value.trim();
    }
    if (cpuInput) {
        service.cpu = parseInt(cpuInput.value) || 8;
    }
    if (memoryInput) {
        service.memory = parseInt(memoryInput.value) || 8;
    }
    
    // Update card display
    updateServiceCardDisplay(currentServiceId);
    
    // Update offcanvas display
    const imageEl = document.getElementById('offcanvas-service-image');
    if (imageEl) {
        imageEl.textContent = service.image || 'No image';
    }
    
    // Auto-save with debounce
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(async () => {
        console.log('Auto-saving service:', service);
        
        // Save to backend
        if (!templateId) {
            console.warn('No template ID available for auto-save');
            return;
        }
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                              getCookie('csrftoken');
            
            const response = await fetch('/service/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    template_id: templateId,
                    service_id: currentServiceId,
                    name: service.name,
                    image: service.image,
                    cpu: service.cpu,
                    memory: service.memory,
                    variables: service.variables,
                    networking: service.networking,
                    position: service.position
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log('Service auto-saved:', data);
            } else {
                console.error('Error auto-saving service:', data.error);
            }
        } catch (error) {
            console.error('Error auto-saving service:', error);
        }
    }, 1000);
}

function updateServiceCardDisplay(serviceId) {
    const service = services[serviceId];
    if (!service) return;
    
    const card = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (!card) return;
    
    const nameEl = card.querySelector('.service-card-name');
    const subtitleEl = card.querySelector('.service-card-subtitle');
    
    if (nameEl) nameEl.textContent = service.name || 'New Service';
    if (subtitleEl) {
        const imageText = service.image || 'No image';
        subtitleEl.textContent = imageText.length > 30 ? imageText.substring(0, 30) + '...' : imageText;
    }
}

function addVariable() {
    if (!currentServiceId) return;
    
    const key = prompt('Enter variable key:');
    if (!key) return;
    
    const value = prompt('Enter variable value:');
    
    if (!services[currentServiceId].variables) {
        services[currentServiceId].variables = {};
    }
    
    services[currentServiceId].variables[key] = value || '';
    updateVariablesList();
    autoSaveService();
}

function updateVariablesList() {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    const variables = services[currentServiceId].variables || {};
    const container = document.getElementById('variables-list-container');
    const overviewList = document.getElementById('offcanvas-variables-list');
    
    if (Object.keys(variables).length === 0) {
        if (container) container.innerHTML = '<p class="text-muted">No Service Variables</p>';
        if (overviewList) overviewList.innerHTML = '<p class="text-muted">No variables added to this service.</p>';
        return;
    }
    
    // Update variables list in Variables tab
    if (container) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Key</th><th>Value</th><th>Actions</th></tr></thead><tbody>';
        
        Object.keys(variables).forEach(key => {
            html += `
                <tr>
                    <td><code>${key}</code></td>
                    <td><input type="text" class="form-control form-control-sm" value="${variables[key]}" onchange="updateVariable('${key}', this.value)" onkeypress="if(event.key === 'Enter') { this.blur(); updateVariable('${key}', this.value); }"></td>
                    <td><button class="btn btn-sm btn-link text-danger" onclick="removeVariable('${key}')"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    // Update overview list
    if (overviewList) {
        let html = '<div class="list-group">';
        Object.keys(variables).forEach(key => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <code>${key}</code>
                        <div class="text-muted small">${variables[key]}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        overviewList.innerHTML = html;
    }
}

function updateVariable(key, value) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    if (!services[currentServiceId].variables) {
        services[currentServiceId].variables = {};
    }
    
    services[currentServiceId].variables[key] = value;
    autoSaveService();
}

function removeVariable(key) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    if (services[currentServiceId].variables) {
        delete services[currentServiceId].variables[key];
        updateVariablesList();
        autoSaveService();
    }
}

function toggleRawEditor() {
    const editor = document.getElementById('raw-editor-container');
    const list = document.getElementById('variables-editor');
    
    if (editor.style.display === 'none') {
        // Show raw editor with current variables
        const variables = services[currentServiceId]?.variables || {};
        document.getElementById('raw-variables-editor').value = JSON.stringify(variables, null, 2);
        editor.style.display = 'block';
        list.style.display = 'none';
    } else {
        editor.style.display = 'none';
        list.style.display = 'block';
    }
}

function saveRawVariables() {
    if (!currentServiceId) return;
    
    try {
        const rawText = document.getElementById('raw-variables-editor').value;
        const variables = JSON.parse(rawText);
        services[currentServiceId].variables = variables;
        updateVariablesList();
        toggleRawEditor();
        autoSaveService();
    } catch (e) {
        alert('Invalid JSON format');
    }
}

function addHttpProxy() {
    if (!currentServiceId) return;
    
    if (!services[currentServiceId].networking) {
        services[currentServiceId].networking = {};
    }
    services[currentServiceId].networking.http = true;
    autoSaveService();
}

function addTcpProxy() {
    if (!currentServiceId) return;
    
    if (!services[currentServiceId].networking) {
        services[currentServiceId].networking = {};
    }
    services[currentServiceId].networking.tcp = true;
    autoSaveService();
}

function showSettingsTab() {
    const settingsTab = document.getElementById('settings-tab');
    if (settingsTab) {
        const tab = new bootstrap.Tab(settingsTab);
        tab.show();
    }
}

function editServiceSource() {
    showSettingsTab();
}

// Toggle credentials form visibility
function toggleCredentialsForm() {
    const form = document.getElementById('credentials-form');
    const addBtn = document.getElementById('add-credentials-btn-wrapper');
    const info = document.getElementById('credentials-info');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        addBtn.style.display = 'none';
        if (info) info.style.display = 'none';
    } else {
        form.style.display = 'none';
        addBtn.style.display = 'block';
    }
}

// Toggle password visibility
function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Save registry credentials
async function saveCredentials() {
    // Check if we have currentServiceId and templateId
    if (!currentServiceId) {
        alert('No service selected. Please click on a service card first.');
        return;
    }
    
    // Get or determine templateId
    let activeTemplateId = templateId;
    if (!activeTemplateId) {
        // Try to get from URL
        const urlParams = new URLSearchParams(window.location.search);
        activeTemplateId = urlParams.get('template_id');
    }
    
    if (!activeTemplateId) {
        alert('No template ID found. Please refresh the page.');
        return;
    }
    
    const username = document.getElementById('registry-username').value.trim();
    const password = document.getElementById('registry-password').value.trim();
    
    if (!username || !password) {
        alert('Please enter both username and password');
        return;
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCookie('csrftoken');
        
        const response = await fetch('/service/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                template_id: activeTemplateId,
                service_id: currentServiceId,
                registry_username: username,
                registry_password: password
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log('Credentials saved successfully');
            
            // Update service object in memory
            if (services[currentServiceId]) {
                services[currentServiceId].has_credentials = true;
                services[currentServiceId].registry_username = username;
            }
            
            // Hide form and show info
            document.getElementById('credentials-form').style.display = 'none';
            document.getElementById('add-credentials-btn-wrapper').style.display = 'none';
            const info = document.getElementById('credentials-info');
            if (info) {
                info.style.display = 'flex';
                info.classList.remove('d-none');
            }
            
            // Clear password field for security
            document.getElementById('registry-password').value = '';
            
            alert('Credentials saved successfully!');
        } else {
            console.error('Error saving credentials:', data.error);
            alert('Error saving credentials: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving credentials:', error);
        alert('Error saving credentials. Please try again.');
    }
}

// Validate Docker image on Docker Hub
let imageValidationTimeout = null;

function debounceValidateImage() {
    clearTimeout(imageValidationTimeout);
    imageValidationTimeout = setTimeout(() => {
        validateDockerImage();
    }, 800); // Wait 800ms after user stops typing
}

async function validateDockerImage() {
    const imageInput = document.getElementById('service-source-image');
    const imageName = imageInput.value.trim();
    const resultDiv = document.getElementById('image-validation-result');
    
    if (!imageName) {
        resultDiv.innerHTML = '';
        return;
    }
    
    // Show loading state
    resultDiv.innerHTML = '<small class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Validating image...</small>';
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCookie('csrftoken');
        
        const response = await fetch('/service/validate-image/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ image: imageName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.exists) {
                resultDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Image found on Docker Hub</small>';
            } else {
                resultDiv.innerHTML = '<small class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Image not found on Docker Hub. It may be private or from another registry.</small>';
            }
        } else {
            resultDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle-fill me-1"></i>Error validating image</small>';
        }
        
        // Auto-save the service with the new image
        if (currentServiceId && services[currentServiceId]) {
            services[currentServiceId].image = imageName;
            autoSaveService();
        }
    } catch (error) {
        console.error('Error validating image:', error);
        resultDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle-fill me-1"></i>Error validating image</small>';
    }
}


function removeServiceCard(serviceId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm('Are you sure you want to remove this service?')) {
        const card = document.querySelector(`[data-service-id="${serviceId}"]`);
        if (card) {
            card.remove();
            delete services[serviceId];
            updateEmptyState();
            
            // Close offcanvas if this service was open
            if (currentServiceId === serviceId) {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('service-offcanvas'));
                if (offcanvas) {
                    offcanvas.hide();
                }
                currentServiceId = null;
            }
        }
    }
}

function updateEmptyState() {
    // Empty state removed - no longer needed
}

function buildTemplateConfig() {
    console.log('buildTemplateConfig called');
    const templateNameEl = document.getElementById('template-name');
    const templateDescEl = document.getElementById('template-description');
    
    if (!templateNameEl) {
        alert('Template name input not found! Please check the Settings tab.');
        return false;
    }
    
    const templateName = templateNameEl.value.trim();
    const templateDesc = templateDescEl ? templateDescEl.value.trim() : '';
    
    if (!templateName) {
        alert('Template name is required! Please go to Settings tab and enter a template name.');
        return false;
    }
    
    // Get workspace ID from settings
    const workspaceId = '{{ settings.railway_workspace_id|default:"" }}';
    if (!workspaceId) {
        alert('Please configure your Railway Workspace ID in Configurations first!');
        return false;
    }
    
    // Ensure we're using the global services object
    const servicesToUse = window.services || services || {};
    
    console.log('Building config for template:', templateName);
    console.log('Available services:', Object.keys(servicesToUse).length);
    console.log('Services object:', servicesToUse);
    
    // Build services config
    const servicesConfig = {};
    Object.keys(servicesToUse).forEach(serviceId => {
        const service = servicesToUse[serviceId];
        if (!service) {
            console.warn('Service not found:', serviceId);
            return;
        }
        
        // Use service name or default
        const serviceName = service.name || 'New Service';
        
        const serviceConfig = {
            name: serviceName,
            source: service.image ? { image: service.image } : {},
            deploy: {
                limitOverride: {
                    containers: {
                        cpu: service.cpu || 8,
                        memoryBytes: (service.memory || 8) * 1024 * 1024 * 1024
                    }
                }
            },
            networking: {
                tcpProxies: {},
                serviceDomains: {}
            }
        };
        
        // Add variables if any
        if (service.variables && Object.keys(service.variables).length > 0) {
            serviceConfig.variables = {};
            Object.keys(service.variables).forEach(key => {
                serviceConfig.variables[key] = { value: service.variables[key] };
            });
        }
        
        // Use service ID as key
        const key = service.id || serviceId;
        servicesConfig[key] = serviceConfig;
        console.log('Added service to config:', key, serviceConfig);
    });
    
    console.log('Total services in config:', Object.keys(servicesConfig).length);
    
    const templateConfig = {
        input: {
            serializedConfig: {
                services: servicesConfig
            },
            workspaceId: workspaceId,
            templateId: null,
            environmentId: null,
            projectId: null
        }
    };
    
    // Set form values
    const nameField = document.getElementById('form-template-name');
    const descField = document.getElementById('form-template-description');
    const configField = document.getElementById('form-template-config');
    
    if (!nameField || !configField) {
        console.error('Form fields not found!', { nameField: !!nameField, configField: !!configField });
        alert('Form fields not found. Please refresh the page.');
        return false;
    }
    
    nameField.value = templateName;
    if (descField) {
        descField.value = templateDesc;
    }
    configField.value = JSON.stringify(templateConfig);
    
    console.log('Template config built successfully');
    console.log('Config:', templateConfig);
    
    return true;
}

function saveTemplate() {
    console.log('saveTemplate called');
    console.log('Current services:', Object.keys(services).length);
    console.log('Services object:', services);
    
    // Save current service data before building config
    if (currentServiceId && services[currentServiceId]) {
        console.log('Saving current service before template save');
        autoSaveService();
        // Wait a bit for autoSave to complete
        setTimeout(() => {
            doSaveTemplate();
        }, 200);
    } else {
        console.log('No current service, proceeding with template save');
        doSaveTemplate();
    }
}

function doSaveTemplate() {
    console.log('doSaveTemplate called');
    
    if (!buildTemplateConfig()) {
        console.error('buildTemplateConfig failed');
        return;
    }
    
    const form = document.getElementById('template-form');
    if (!form) {
        console.error('Template form not found!');
        alert('Form not found. Please refresh the page.');
        return;
    }
    
    // Verify form fields have values
    const nameValue = document.getElementById('form-template-name').value;
    const configValue = document.getElementById('form-template-config').value;
    
    console.log('Form values:', {
        name: nameValue,
        configLength: configValue ? configValue.length : 0
    });
    
    if (!nameValue) {
        alert('Template name is required!');
        return;
    }
    
    if (!configValue || configValue === '{}') {
        alert('Template configuration is empty. Please add at least one service.');
        return;
    }
    
    // Show loading indicator
    const createBtn = document.querySelector('button[onclick="saveTemplate()"]');
    if (createBtn) {
        createBtn.disabled = true;
        const originalText = createBtn.innerHTML;
        createBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Creating...';
        
        // Reset button after 10 seconds if no response
        setTimeout(() => {
            if (createBtn.disabled) {
                createBtn.disabled = false;
                createBtn.innerHTML = originalText;
                console.warn('Button reset due to timeout');
            }
        }, 10000);
    }
    
    // Create form data as plain object (HTMX values expects plain object, not FormData)
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
    const formValues = {
        'csrfmiddlewaretoken': csrfToken,
        'form_type': 'template',
        'name': document.getElementById('form-template-name').value,
        'description': document.getElementById('form-template-description').value || '',
        'template_config': document.getElementById('form-template-config').value
    };
    
    // Log what we're sending
    console.log('Submitting form data:');
    Object.keys(formValues).forEach(key => {
        if (key === 'template_config') {
            console.log(key, ':', formValues[key].substring(0, 200) + '...');
        } else if (key !== 'csrfmiddlewaretoken') {
            console.log(key, ':', formValues[key]);
        }
    });
    
    // Submit via fetch (more reliable than HTMX ajax for form data)
    fetch('{% url "accounts:settings" %}?tab=template', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
            'HX-Request': 'true',
            'HX-Target': 'template-content'
        },
        body: new URLSearchParams(formValues).toString()
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        console.log('Server response received');
        
        // Reset button
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="bi bi-save me-1"></i> Create Template';
        }
        
        // Check if response contains error indicators
        const hasErrors = html.includes('is-invalid') || 
                         html.includes('alert-danger') || 
                         html.includes('errorlist');
        
        // Check if response contains success indicator (Django messages)
        const hasSuccess = html.includes('alert-success') || 
                          html.includes('created successfully');
        
        if (hasErrors) {
            console.log('Form has validation errors');
            // Update the template content to show errors
            const templateContent = document.getElementById('template-content');
            if (templateContent) {
                templateContent.innerHTML = html;
            }
            alert('Please fix the errors in the form.');
        } else if (hasSuccess) {
            console.log('Template created successfully');
            // Redirect to template list to show updated list
            window.location.href = '{% url "accounts:settings" %}?tab=template';
        } else {
            // Fallback - update content and check visually
            console.log('Response received, updating content');
            const templateContent = document.getElementById('template-content');
            if (templateContent) {
                templateContent.innerHTML = html;
            }
            // Redirect to refresh the page with updated template list
            window.location.href = '{% url "accounts:settings" %}?tab=template';
        }
    })
    .catch(error => {
        console.error('Error creating template:', error);
        if (createBtn) {
            createBtn.disabled = false;
            createBtn.innerHTML = '<i class="bi bi-save me-1"></i> Create Template';
        }
        alert('Error creating template: ' + (error.message || 'Unknown error'));
    });
}

// Calculate navbar height and set CSS variable
function setNavbarHeight() {
    const navbar = document.querySelector('.navbar');
    if (navbar) {
        const navbarHeight = navbar.offsetHeight;
        document.documentElement.style.setProperty('--navbar-height', navbarHeight + 'px');
    }
}

// Drag and drop functionality
// Variables are already declared at the top of the script

function makeCardDraggable(cardElement, serviceId) {
    const service = services[serviceId];
    if (service && service.position) {
        cardElement.style.left = service.position.x + 'px';
        cardElement.style.top = service.position.y + 'px';
    }
    
    // Store card-specific drag state
    cardDragData.set(cardElement, {
        mousedownTime: 0,
        mousedownPos: { x: 0, y: 0 },
        hasMoved: false,
        isHolding: false,
        holdTimer: null
    });
    
    // Make entire card draggable on click and hold (anywhere except remove button)
    cardElement.addEventListener('mousedown', function(e) {
        // Don't start drag if clicking on remove button
        if (e.target.closest('.btn-remove')) {
            return;
        }
        
        const dragData = cardDragData.get(cardElement);
        dragData.mousedownTime = Date.now();
        dragData.mousedownPos.x = e.clientX;
        dragData.mousedownPos.y = e.clientY;
        dragData.hasMoved = false;
        dragData.isHolding = true;
        
        // Set a timer - if held for 200ms, enable dragging
        dragData.holdTimer = setTimeout(() => {
            if (dragData.isHolding && !dragData.hasMoved) {
                // User is holding - enable dragging
                draggedElement = cardElement;
                isDragging = false;
                
                const rect = cardElement.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                dragStartPos.x = e.clientX;
                dragStartPos.y = e.clientY;
            }
        }, 200);
    });
    
    // Content area already has onclick handler from HTML
}

// Cache for drag performance
let canvasRectCache = null;
let cardSizeCache = { width: 0, height: 0 };
let basePosition = { x: 0, y: 0 };

// Global mouse move handler for dragging - optimized for smoothness
function handleMouseMove(e) {
    if (!draggedElement) return;
    
    const deltaX = Math.abs(e.clientX - dragStartPos.x);
    const deltaY = Math.abs(e.clientY - dragStartPos.y);
    
    // Check if movement exceeds threshold
    if (!isDragging && (deltaX > dragThreshold || deltaY > dragThreshold)) {
        isDragging = true;
        draggedElement.classList.add('dragging');
        
        // Clear any hold timer
        const dragData = cardDragData.get(draggedElement);
        if (dragData && dragData.holdTimer) {
            clearTimeout(dragData.holdTimer);
            dragData.holdTimer = null;
        }
        
        // Store base position when drag starts
        basePosition.x = parseFloat(draggedElement.style.left) || 0;
        basePosition.y = parseFloat(draggedElement.style.top) || 0;
        
        // Cache canvas rect and card size once when drag starts
        const canvas = document.getElementById('services-canvas');
        if (canvas) {
            canvasRectCache = canvas.getBoundingClientRect();
            cardSizeCache.width = draggedElement.offsetWidth;
            cardSizeCache.height = draggedElement.offsetHeight;
        }
        
        // Mark that this card has moved - prevent click
        if (dragData) {
            dragData.hasMoved = true;
            dragData.isHolding = false;
        }
        
        // Disable click when dragging starts
        const cardContent = draggedElement.querySelector('.service-card-content');
        if (cardContent) {
            cardContent.dataset.dragging = 'true';
        }
    }
    
    if (!isDragging) return;
    
    e.preventDefault();
    
    if (!canvasRectCache) return;
    
    // Calculate new position relative to canvas
    let newX = e.clientX - canvasRectCache.left - dragOffset.x;
    let newY = e.clientY - canvasRectCache.top - dragOffset.y;
    
    // Constrain to canvas bounds
    const maxX = canvasRectCache.width - cardSizeCache.width;
    const maxY = canvasRectCache.height - cardSizeCache.height;
    
    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));
    
    // Calculate transform offset from base position - use transform for smooth GPU-accelerated movement
    const translateX = newX - basePosition.x;
    const translateY = newY - basePosition.y;
    
    // Apply transform directly - this is GPU accelerated and smooth
    draggedElement.style.transform = `translate3d(${translateX}px, ${translateY}px, 0)`;
}

document.addEventListener('mousemove', handleMouseMove);

document.addEventListener('mouseup', function(e) {
    const wasDragging = isDragging;
    
    if (draggedElement) {
        // Finalize position - update left/top and clear transform
        if (wasDragging) {
            const canvas = document.getElementById('services-canvas');
            if (canvas && canvasRectCache) {
                // Calculate final position
                let finalX = e.clientX - canvasRectCache.left - dragOffset.x;
                let finalY = e.clientY - canvasRectCache.top - dragOffset.y;
                
                // Constrain to canvas bounds
                const maxX = canvasRectCache.width - cardSizeCache.width;
                const maxY = canvasRectCache.height - cardSizeCache.height;
                
                finalX = Math.max(0, Math.min(finalX, maxX));
                finalY = Math.max(0, Math.min(finalY, maxY));
                
                // Update base position and clear transform
                draggedElement.style.left = finalX + 'px';
                draggedElement.style.top = finalY + 'px';
                draggedElement.style.transform = '';
                
                // Update service position in memory
                const serviceId = draggedElement.getAttribute('data-service-id');
                if (serviceId && services[serviceId]) {
                    services[serviceId].position = { x: finalX, y: finalY };
                    
                    // Save position to backend
                    savePositionToBackend(serviceId, finalX, finalY);
                }
            }
        }
        
        // Clean up drag state
        const dragData = cardDragData.get(draggedElement);
        if (dragData) {
            if (dragData.holdTimer) {
                clearTimeout(dragData.holdTimer);
                dragData.holdTimer = null;
            }
            dragData.isHolding = false;
        }
        
        const cardContent = draggedElement.querySelector('.service-card-content');
        if (cardContent) {
            delete cardContent.dataset.dragging;
        }
        
        draggedElement.classList.remove('dragging');
        
        // Clear caches
        canvasRectCache = null;
        cardSizeCache = { width: 0, height: 0 };
        basePosition = { x: 0, y: 0 };
        
        // If we were dragging, mark it so click doesn't fire
        if (wasDragging) {
            if (dragData) {
                dragData.hasMoved = true;
            }
        } else {
            // If we weren't dragging, reset so click can work
            if (dragData) {
                dragData.hasMoved = false;
            }
        }
        
        // Clear dragged element after a small delay to allow click
        setTimeout(() => {
            draggedElement = null;
            isDragging = false;
        }, 100);
    } else {
        // Clean up any hold timers if mouse is released without dragging
        document.querySelectorAll('.service-card').forEach(card => {
            const dragData = cardDragData.get(card);
            if (dragData && dragData.holdTimer) {
                clearTimeout(dragData.holdTimer);
                dragData.holdTimer = null;
                dragData.isHolding = false;
            }
        });
        isDragging = false;
    }
});

// Function to save position to backend
async function savePositionToBackend(serviceId, x, y) {
    if (!templateId) {
        console.warn('No template ID available for position save');
        return;
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                          getCookie('csrftoken');
        
        const response = await fetch('/service/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                template_id: templateId,
                service_id: serviceId,
                position: { x: x, y: y }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log('Position saved:', serviceId, x, y);
        } else {
            console.error('Error saving position:', data.error);
        }
    } catch (error) {
        console.error('Error saving position:', error);
    }
}

// This function is already defined above - this is just to ensure it's available

// Initialize empty state on load and hide sidebar
// Use HTMX afterSwap event for proper initialization
function initializeTemplateEditor() {
    console.log('Initializing template editor...');
    
    setNavbarHeight();
    hideSidebar();
    
    // Load existing services if template ID is available
    if (templateId) {
        loadServicesFromBackend();
    } else {
        updateEmptyState();
    }
    
    // Only add resize listener once
    if (!window.templateEditorResizeListenerAdded) {
        window.templateEditorResizeListenerAdded = true;
        window.addEventListener('resize', setNavbarHeight);
    }
    
    // Make existing cards draggable (if any)
    document.querySelectorAll('.service-card').forEach(card => {
        const serviceId = card.getAttribute('data-service-id');
        if (serviceId) {
            makeCardDraggable(card, serviceId);
        }
    });
    
    // Make sure functions are globally accessible
    window.openServiceDetails = openServiceDetails;
    window.handleCardClick = handleCardClick;
    window.removeServiceCard = removeServiceCard;
    window.addServiceCard = addServiceCard;
    window.addVariable = addVariable;
    window.updateVariable = updateVariable;
    window.removeVariable = removeVariable;
    window.toggleRawEditor = toggleRawEditor;
    window.saveRawVariables = saveRawVariables;
    window.addHttpProxy = addHttpProxy;
    window.addTcpProxy = addTcpProxy;
    window.showSettingsTab = showSettingsTab;
    window.editServiceSource = editServiceSource;
    window.updateServiceName = updateServiceName;
    window.autoSaveService = autoSaveService;
    
    console.log('Template editor initialized');
}

// Listen for HTMX afterSwap event to initialize after content loads
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Check if the swapped content is the template editor
    if (evt.detail.target.id === 'template-content' || evt.detail.target.querySelector('#template-editor-full')) {
        console.log('Template editor content swapped, initializing...');
        // Small delay to ensure DOM is fully ready
        setTimeout(initializeTemplateEditor, 50);
    }
});

// Listen for HTMX beforeSwap to cleanup when leaving template editor
document.body.addEventListener('htmx:beforeSwap', function(evt) {
    // If we're swapping out the template editor, cleanup
    if (evt.detail.target.id === 'template-content' && evt.detail.target.querySelector('#template-editor-full')) {
        console.log('Cleaning up template editor...');
        // Reset template ID from context
        if (typeof window.templateIdFromContext !== 'undefined') {
            delete window.templateIdFromContext;
        }
    }
});

// Also initialize on DOM ready for direct page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTemplateEditor);
} else {
    // DOM already loaded, check if template editor exists
    if (document.getElementById('template-editor-full')) {
        initializeTemplateEditor();
    }
}

// Function to load services from backend
async function loadServicesFromBackend() {
    if (!templateId) {
        console.warn('No template ID available');
        updateEmptyState();
        return;
    }
    
    try {
        const response = await fetch(`/template/${templateId}/services/`);
        const data = await response.json();
        
        if (data.success && data.services && data.services.length > 0) {
            console.log('Loading services from backend:', data.services);
            
            // Clear existing services
            services = {};
            window.services = services;
            serviceCounter = 0;
            
            // Load each service
            data.services.forEach(serviceData => {
                // Extract counter from service_id (e.g., "service_1" -> 1)
                const counterMatch = serviceData.service_id.match(/\d+$/);
                if (counterMatch) {
                    const counter = parseInt(counterMatch[0]);
                    if (counter > serviceCounter) {
                        serviceCounter = counter;
                    }
                }
                
                // Add service to services object
                services[serviceData.service_id] = {
                    id: serviceData.service_id,
                    name: serviceData.name,
                    image: serviceData.image,
                    cpu: serviceData.cpu,
                    memory: serviceData.memory,
                    variables: serviceData.variables,
                    networking: serviceData.networking,
                    position: serviceData.position,
                    has_credentials: serviceData.has_credentials || false,
                    registry_username: serviceData.registry_username || ''
                };
                
                // Render the service card
                renderServiceCard(serviceData.service_id);
            });
            
            window.services = services;
            window.serviceCounter = serviceCounter;
            
            console.log('Services loaded:', Object.keys(services).length);
            updateEmptyState();
        } else {
            console.log('No services found for this template');
            updateEmptyState();
        }
    } catch (error) {
        console.error('Error loading services:', error);
        updateEmptyState();
    }
}

// Function to render a service card on the canvas
function renderServiceCard(serviceId) {
    const canvas = document.getElementById('services-canvas');
    const service = services[serviceId];
    
    if (!canvas || !service) {
        console.error('Canvas or service not found');
        return;
    }
    
    // Create service card HTML
    const cardHtml = `
        <div class="service-card railway-card" 
             data-service-id="${serviceId}"
             style="left: ${service.position.x}px; top: ${service.position.y}px;">
            <button 
                type="button" 
                class="btn btn-sm btn-link text-danger p-0 btn-remove"
                onclick="removeServiceCard('${serviceId}', event)"
                title="Remove service">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="service-card-content" onclick="handleCardClick('${serviceId}', event)">
                <div class="service-card-icon-wrapper">
                    <i class="bi bi-box service-card-icon"></i>
                </div>
                <div class="service-card-info">
                    <div class="service-card-name">${service.name}</div>
                    <div class="service-card-subtitle">${service.image || 'No image'}</div>
                </div>
                <div class="service-card-badge">
                    <i class="bi bi-list-ul"></i>
                    <span>No config required</span>
                </div>
            </div>
        </div>
    `;
    
    canvas.insertAdjacentHTML('beforeend', cardHtml);
    
    // Make card draggable
    const cardElement = canvas.querySelector(`[data-service-id="${serviceId}"]`);
    if (cardElement && typeof makeCardDraggable === 'function') {
        makeCardDraggable(cardElement, serviceId);
    }
}

function hideSidebar() {
    const sidebar = document.querySelector('.settings-container .col-md-3');
    const mainContent = document.getElementById('main-content-wrapper');
    const settingsMainContent = document.getElementById('settings-main-content');
    const settingsContainer = document.querySelector('.settings-container');
    const mainContentContainer = document.getElementById('main-content');
    const templateContent = document.getElementById('template-content');
    
    if (sidebar) sidebar.style.display = 'none';
    if (mainContent) {
        mainContent.classList.remove('col-md-9');
        mainContent.classList.add('col-12');
        mainContent.style.padding = '0';
    }
    if (settingsMainContent) {
        settingsMainContent.style.padding = '0';
        settingsMainContent.style.height = '100%';
    }
    if (templateContent) {
        templateContent.classList.add('template-editor-mode');
        templateContent.style.height = '100%';
    }
    if (settingsContainer) {
        settingsContainer.classList.add('template-editor-mode');
    }
    if (mainContentContainer) {
        mainContentContainer.classList.add('template-editor-mode');
        mainContentContainer.style.paddingTop = '0';
        mainContentContainer.style.paddingBottom = '0';
        mainContentContainer.style.marginTop = '0';
        mainContentContainer.style.marginBottom = '0';
    }
}

// Hide sidebar immediately when template editor loads
hideSidebar();
</script>

<style>
.template-editor-full {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    display: block;
    overflow: hidden;
}

.services-canvas-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: block;
}

.add-button-container {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
}

.services-canvas {
    background-image: 
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    background-color: #0f0f0f;
    border-radius: 0;
    padding: 2rem;
    padding-top: 4rem;
    height: 100%;
    position: relative;
    width: 100%;
    margin: 0;
    overflow: hidden;
}

#architecture-tab {
    display: block !important;
    width: 100%;
    height: 100%;
}

.template-editor-full {
    width: 100%;
    height: 100%;
}

.service-card {
    background: #1a1a1a;
    border: 2px solid #2d2d2d;
    border-radius: 8px;
    padding: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    cursor: grab;
    position: absolute;
    width: 200px;
    min-height: 140px;
    user-select: none;
    z-index: 10;
    will-change: transform;
    display: flex;
    flex-direction: column;
}

.service-card:active {
    cursor: grabbing;
}

.service-card:hover {
    border-color: #6366f1;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.service-card.dragging {
    opacity: 0.85;
    z-index: 1000;
    cursor: grabbing !important;
    transition: none;
    will-change: transform;
    pointer-events: none;
}

.service-card.selected {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.service-card-content {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
    cursor: pointer;
    flex: 1;
    min-height: 0;
    height: 100%;
    justify-content: space-between;
    padding: 0.125rem 0;
}

.service-card-icon-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

.service-card-icon {
    font-size: 1.75rem;
    color: #ffffff;
    display: block;
    opacity: 0.9;
}

.service-card-info {
    flex: 0 1 auto;
    min-width: 0;
    text-align: center;
    flex-shrink: 0;
}

.service-card-name {
    color: #ffffff;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    line-height: 1.3;
    word-wrap: break-word;
    overflow-wrap: break-word;
    text-align: center;
    display: block;
}

.service-card-subtitle {
    color: #9ca3af;
    font-size: 0.75rem;
    line-height: 1.4;
    word-wrap: break-word;
    overflow-wrap: break-word;
    display: block;
    text-align: center;
}

.service-card-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 0.6875rem;
    margin-top: auto;
    gap: 0.25rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    flex-shrink: 0;
}

.service-card-badge i {
    font-size: 0.75rem;
    opacity: 0.7;
}

.service-card-badge span {
    font-size: 0.6875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.service-card .btn-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 20;
    background: rgba(26, 26, 26, 0.8);
    border-radius: 4px;
    padding: 0.25rem;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}


.service-card:hover .btn-remove {
    opacity: 1;
}

.service-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.service-icon {
    font-size: 1.5rem;
    color: #6c757d;
}

.service-card-body {
    padding-top: 0.5rem;
}

.service-config-info {
    display: flex;
    align-items: center;
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.offcanvas {
    background-color: var(--white);
    color: var(--black);
    width: 50% !important;
    max-width: none !important;
    height: calc(100vh - var(--navbar-height, 70px)) !important;
    position: fixed !important;
    top: var(--navbar-height, 70px) !important;
    right: 0 !important;
    bottom: auto !important;
    left: auto !important;
    z-index: 1055 !important;
    transform: translateX(100%) !important;
    transition: transform 0.3s ease-in-out !important;
    border-left: 1px solid var(--gray-200);
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
}

.offcanvas.show {
    transform: translateX(0) !important;
}

.offcanvas-header {
    background-color: var(--white);
    border-bottom: 1px solid var(--gray-200) !important;
    padding: 1.5rem 1.5rem 1.25rem 1.5rem;
    min-height: 70px;
}

.offcanvas-title-input {
    background-color: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    color: var(--black);
    font-size: 1.25rem;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    width: 100%;
    min-width: 200px;
    transition: all 0.2s;
    font-family: 'Space Grotesk', sans-serif;
}

.offcanvas-title-input:not(.editing) {
    border-color: transparent;
    background-color: transparent;
    padding-left: 0;
    padding-right: 0;
    cursor: pointer;
}

.offcanvas-title-input:not(.editing):hover {
    border-bottom: 1px dashed var(--gray-300);
    padding-bottom: 0.25rem;
}

.offcanvas-title-input.editing {
    border-color: var(--black);
    background-color: var(--white);
    padding: 0.5rem 0.75rem;
}

.offcanvas-title-input:focus {
    outline: none;
    border-color: var(--black);
    background-color: var(--white);
    box-shadow: 0 0 0 1px var(--black);
}

.offcanvas-body {
    background-color: var(--white);
    overflow-y: auto;
    max-height: calc(100vh - var(--navbar-height, 70px) - 70px);
    color: var(--black);
    padding: 0;
}

.nav-tabs {
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 0;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    gap: 0.5rem;
}

.nav-tabs .nav-item {
    margin-bottom: 0;
}

.nav-tabs .nav-link {
    color: var(--gray-700);
    border-color: transparent;
    padding: 0.5rem 1rem;
    border-radius: 0;
    transition: all 0.2s;
    font-weight: 400;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    color: var(--black);
    background-color: var(--gray-50);
}

.nav-tabs .nav-link.active {
    color: var(--black);
    background-color: transparent;
    border-color: transparent;
    border-bottom-color: var(--black);
    font-weight: 500;
}

.tab-content {
    color: var(--black);
    min-height: 400px;
    padding-top: 1rem;
}

#service-offcanvas h6 {
    color: var(--black);
    font-weight: 600;
    font-size: 0.9375rem;
    letter-spacing: -0.01em;
}

#service-offcanvas h6 i {
    color: var(--gray-600);
}

#service-offcanvas .card {
    border-radius: 0;
}

#service-offcanvas .card-body {
    padding: 1.5rem;
}

#service-offcanvas .form-control, 
#service-offcanvas .form-select {
    background-color: var(--white);
    border: 1px solid var(--gray-300);
    color: var(--black);
    border-radius: 0;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: border-color 0.2s;
}

#service-offcanvas .form-control:focus, 
#service-offcanvas .form-select:focus {
    background-color: var(--white);
    border-color: var(--black);
    color: var(--black);
    box-shadow: none;
    outline: none;
}

#service-offcanvas .form-label {
    font-weight: 500;
    color: var(--black);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    display: block;
}

#service-offcanvas .form-text {
    color: var(--gray-600);
    font-size: 0.8125rem;
    margin-top: 0.5rem;
}

.card {
    background-color: var(--white);
    border: 1px solid var(--gray-200);
}

.table {
    color: var(--black);
}

.table thead th {
    border-color: var(--gray-200);
    color: var(--gray-700);
    font-weight: 500;
}

.table tbody td {
    border-color: var(--gray-200);
}

.settings-section {
    max-width: 600px;
}

/* Offcanvas specific button styles */
#service-offcanvas .btn-primary {
    background-color: var(--black);
    border-color: var(--black);
    color: var(--white);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#service-offcanvas .btn-primary:hover {
    background-color: var(--gray-900);
    border-color: var(--gray-900);
    color: var(--white);
}

#service-offcanvas .btn-outline-secondary {
    border-color: var(--gray-300);
    color: var(--black);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

#service-offcanvas .btn-outline-secondary:hover {
    background-color: var(--gray-200);
    border-color: var(--gray-300);
    color: var(--black);
}

#service-offcanvas .btn-outline-primary {
    border-color: var(--black);
    color: var(--black);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

#service-offcanvas .btn-outline-primary:hover {
    background-color: var(--black);
    border-color: var(--black);
    color: var(--white);
}

#service-offcanvas .btn-sm {
    padding: 0.5rem 0.875rem;
    font-size: 0.8125rem;
}

#service-offcanvas .service-offcanvas-icon {
    color: var(--black);
}

#service-offcanvas .gap-2 {
    gap: 0.75rem !important;
}

/* Better spacing utilities for offcanvas */
#service-offcanvas .mb-4 {
    margin-bottom: 2rem !important;
}

#service-offcanvas .mb-5 {
    margin-bottom: 3rem !important;
}

#service-offcanvas .mb-3 {
    margin-bottom: 1.5rem !important;
}

/* Settings Single Page Styles */
.settings-single-page {
    height: 100%;
    display: flex;
    flex-direction: column;
}

.settings-filter-bar {
    z-index: 10;
}

.settings-filter-bar input {
    background-color: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.settings-filter-bar input:focus {
    outline: none;
    border-color: var(--black);
    background-color: var(--white);
    box-shadow: none;
}

.settings-scroll-content {
    overflow-y: auto;
    flex: 1;
    max-width: 700px;
}

.settings-section-block {
    scroll-margin-top: 80px;
    position: relative;
}

/* Vertical line connecting icons - from bottom of icon to next icon */
.settings-section-block:not(.last-section)::before {
    content: '';
    position: absolute;
    left: 17px;
    top: 36px;
    height: calc(100% + 23px);
    width: 2px;
    background-color: var(--gray-300, #d1d5db);
    z-index: 0;
}

.settings-icon-wrapper {
    position: relative;
    width: 36px;
    height: 36px;
    min-width: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--white);
    border: 2px solid var(--gray-300, #d1d5db);
    border-radius: 50%;
    margin-right: 1rem;
    z-index: 1;
}

.settings-section-icon {
    font-size: 1.125rem;
    color: var(--gray-700);
}

.settings-section-block h5 {
    font-size: 1.25rem;
    font-weight: 600;
}

.settings-section-block h6 {
    font-size: 1rem;
    font-weight: 600;
}

.settings-section-content {
    padding-left: 3rem;
}

.networking-item {
    background-color: var(--gray-50);
    transition: all 0.2s;
}

.networking-item:hover {
    background-color: var(--gray-100);
}

@media (max-width: 768px) {
    .services-canvas {
        grid-template-columns: 1fr;
    }
    
    .offcanvas {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    #service-offcanvas .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }
    
    #service-offcanvas .row > * {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}
</style>
