{% load crispy_forms_tags %}

<div id="template-editor-full" class="template-editor-full">
    <!-- Architecture Tab Content (Grid Only) -->
    <div id="architecture-tab" class="tab-content">
        <!-- Services Canvas Container -->
        <div class="services-canvas-wrapper">
            <!-- Add Button (Top Right) -->
            <div class="add-button-container">
                <button 
                    type="button" 
                    class="btn btn-dark text-white"
                    onclick="addServiceCard()">
                    <i class="bi bi-plus-circle me-1"></i> ADD NEW
                </button>
            </div>
            
            <!-- Services Grid Canvas -->
            <div id="services-canvas" class="services-canvas">
                <!-- Service cards will be added here dynamically -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="text-center py-5">
                <i class="bi bi-box" style="font-size: 4rem; color: #dee2e6;"></i>
                <p class="text-muted mt-3 mb-4">No services added yet</p>
                <button 
                    type="button" 
                    class="btn btn-dark text-white"
                    onclick="addServiceCard()">
                    <i class="bi bi-plus-circle me-1"></i> ADD YOUR FIRST SERVICE
                </button>
            </div>
        </div>
        
        <!-- Off-Canvas Panel for Service Details -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="service-offcanvas" aria-labelledby="service-offcanvas-label" data-bs-backdrop="true" data-bs-scroll="true">
            <div class="offcanvas-header border-bottom">
                <div class="d-flex align-items-center flex-grow-1">
                    <i class="bi bi-box service-offcanvas-icon me-3" id="offcanvas-service-icon" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <input 
                            type="text" 
                            class="offcanvas-title-input" 
                            id="offcanvas-service-name-input" 
                            value="Service Name"
                            placeholder="Enter service name"
                            onchange="updateServiceName(this.value)"
                            onfocus="this.classList.add('editing')"
                            onblur="this.classList.remove('editing'); updateServiceName(this.value);">
                    </div>
                </div>
                <button type="button" class="btn-close ms-3" data-bs-dismiss="offcanvas" aria-label="Close" onclick="if(typeof hideOffcanvasFallback === 'function') { hideOffcanvasFallback(); } else if(typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) { const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('service-offcanvas')); if(offcanvas) offcanvas.hide(); }"></button>
            </div>
            <div class="offcanvas-body p-0">
                <!-- Service Tabs -->
                <ul class="nav nav-tabs border-bottom px-4 pt-3" id="service-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane" type="button" role="tab">
                            Overview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="variables-tab" data-bs-toggle="tab" data-bs-target="#variables-pane" type="button" role="tab">
                            Variables
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                            Settings
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content px-4 py-4" id="service-tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-code-square me-2"></i> Source</h6>
                            <div class="card" style="background-color: var(--gray-50, #fafafa); border: 1px solid var(--gray-200, #e5e5e5);">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-box me-3" style="font-size: 1.75rem; color: var(--gray-600);"></i>
                                            <div>
                                                <div class="fw-bold mb-1" id="offcanvas-service-name" style="font-size: 1rem;">Service Name</div>
                                                <small class="text-muted" id="offcanvas-service-image">No image</small>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editServiceSource()">
                                            <i class="bi bi-pencil me-1"></i> Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-slash-circle me-2"></i> Environment Variables</h6>
                            <div id="offcanvas-variables-list" class="mb-3">
                                <p class="text-muted mb-0">No variables added to this service.</p>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addVariable()">
                                <i class="bi bi-plus-circle me-1"></i> Add variables
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-gear me-2"></i> Service Settings</h6>
                            <p class="text-muted mb-3">No settings have been configured for this service.</p>
                            <button type="button" class="btn btn-primary btn-sm" onclick="showSettingsTab()">
                                <i class="bi bi-pencil me-1"></i> Edit settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- Variables Tab -->
                    <div class="tab-pane fade" id="variables-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="mb-0 fw-semibold">Service Variables</h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="toggleRawEditor()">
                                    <i class="bi bi-code me-1"></i> Raw Editor
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addVariable()">
                                    <i class="bi bi-plus-circle me-1"></i> New Variable
                                </button>
                            </div>
                        </div>
                        <div id="variables-editor">
                            <div id="variables-list-container">
                                <!-- Variables will be added here -->
                            </div>
                        </div>
                        <div id="raw-editor-container" style="display: none;">
                            <textarea class="form-control font-monospace" rows="10" id="raw-variables-editor" placeholder='{"KEY": "value"}'></textarea>
                            <button type="button" class="btn btn-primary btn-sm mt-2" onclick="saveRawVariables()">Save</button>
                        </div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings-pane" role="tabpanel">
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-code-square me-2"></i> Source</h6>
                            <div class="mb-3">
                                <label class="form-label fw-medium mb-2">Source Image</label>
                                <input type="text" class="form-control" id="service-source-image" placeholder="e.g., docker-image:tag or ghcr.io/..." onchange="autoSaveService()">
                                <small class="form-text text-muted mt-2 d-block">Configure auto updates</small>
                            </div>
                        </div>
                        
                        <div class="mb-5">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-wifi me-2"></i> Networking</h6>
                            <div class="mb-3">
                                <label class="form-label fw-medium mb-2">Public Networking</label>
                                <p class="text-muted small mb-3">Make this service publicly accessible via HTTP, TCP, or both.</p>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addHttpProxy()">
                                        <i class="bi bi-plus me-1"></i> HTTP Proxy
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTcpProxy()">
                                        <i class="bi bi-plus me-1"></i> TCP Proxy
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-4 fw-semibold"><i class="bi bi-rocket me-2"></i> Deploy</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium mb-2">CPU</label>
                                    <input type="number" class="form-control" id="service-cpu" value="8" min="1" max="32" onchange="autoSaveService()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium mb-2">Memory (GB)</label>
                                    <input type="number" class="form-control" id="service-memory" value="8" min="1" max="32" onchange="autoSaveService()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Tab Content -->
    <div id="settings-tab" class="tab-content" style="display: {% if template_action == 'settings' %}block{% else %}none{% endif %};">
        <div class="row g-0">
            <!-- Settings Sidebar -->
            <div class="col-md-3 border-end bg-light" style="min-height: 400px;">
                <div class="p-3">
                    <ul class="nav nav-pills flex-column" role="tablist">
                        <li class="nav-item mb-2">
                            <button 
                                class="nav-link w-100 text-start active" 
                                type="button"
                                onclick="showSettingsSection('general')">
                                <i class="bi bi-gear me-2"></i> General
                            </button>
                        </li>
                        <li class="nav-item mb-2">
                            <button 
                                class="nav-link w-100 text-start" 
                                type="button"
                                onclick="showSettingsSection('danger')">
                                <i class="bi bi-trash me-2"></i> Danger
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="col-md-9">
                <div class="p-4">
                    <!-- General Section -->
                    <div id="settings-general" class="settings-section">
                        <h5 class="mb-4">Basic Info</h5>
                        
                        <div class="mb-3">
                            <label for="template-name" class="form-label">Name</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="template-name" 
                                placeholder="Enter template name" 
                                required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="template-icon" class="form-label">Icon</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="template-icon" 
                                placeholder="https://devicons.railway.com/i/bun.svg">
                            <small class="form-text text-muted">Icon URL for the template</small>
                        </div>
                        
                        <div class="mb-4">
                            <label for="template-description" class="form-label">Description</label>
                            <textarea 
                                class="form-control" 
                                id="template-description" 
                                rows="4"
                                placeholder="Enter template description"></textarea>
                        </div>
                        
                        <button 
                            type="button" 
                            class="btn btn-primary"
                            onclick="updateTemplateInfo()">
                            Update Info
                        </button>
                    </div>
                    
                    <!-- Danger Section -->
                    <div id="settings-danger" class="settings-section" style="display: none;">
                        <h5 class="mb-4 text-danger">Danger Zone</h5>
                        <div class="card border-danger">
                            <div class="card-body">
                                <h6 class="card-title">Delete Template</h6>
                                <p class="card-text text-muted">Once you delete a template, there is no going back. Please be certain.</p>
                                <button type="button" class="btn btn-danger">
                                    Delete Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden form for submission -->
    <form id="template-form" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="form_type" value="template">
        <input type="hidden" name="name" id="form-template-name">
        <input type="hidden" name="description" id="form-template-description">
        <input type="hidden" name="template_config" id="form-template-config">
    </form>
</div>

<script>
let serviceCounter = 0;
let services = {};
let cardDragData = new Map(); // Store drag state per card - initialize early
let draggedElement = null;
let dragOffset = { x: 0, y: 0 };
let dragStartPos = { x: 0, y: 0 };
let isDragging = false;
let dragThreshold = 5; // pixels to move before drag starts

// Handle card click - define early so it's available globally
function handleCardClick(serviceId, event) {
    console.log('handleCardClick called for:', serviceId);
    
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // Check if we were dragging
    const cardElement = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (cardElement && cardDragData) {
        const dragData = cardDragData.get(cardElement);
        // Only prevent if we actually dragged
        if (dragData && dragData.hasMoved) {
            console.log('Click ignored - card was dragged');
            dragData.hasMoved = false;
            return;
        }
    }
    
    // Open the service details - check if function exists
    if (typeof openServiceDetails === 'function') {
        console.log('Calling openServiceDetails');
        openServiceDetails(serviceId);
    } else {
        console.error('openServiceDetails function not found');
        // Fallback - try to call it later
        setTimeout(() => {
            if (typeof openServiceDetails === 'function') {
                openServiceDetails(serviceId);
            } else {
                console.error('openServiceDetails still not available');
            }
        }, 100);
    }
}

// Make it globally available immediately
window.handleCardClick = handleCardClick;

function showTab(tabName) {
    // Hide all tabs
    document.getElementById('architecture-tab').style.display = 'none';
    document.getElementById('settings-tab').style.display = 'none';
    
    // Show selected tab
    if (tabName === 'architecture') {
        document.getElementById('architecture-tab').style.display = 'block';
    } else if (tabName === 'settings') {
        document.getElementById('settings-tab').style.display = 'block';
    }
    
    // Update active tab button
    document.querySelectorAll('.btn-link').forEach(btn => {
        const btnText = btn.textContent.trim();
        if (btnText === 'Architecture' || btnText === 'Settings') {
            if ((tabName === 'architecture' && btnText === 'Architecture') ||
                (tabName === 'settings' && btnText === 'Settings')) {
                btn.style.borderBottomColor = '#000';
            } else {
                btn.style.borderBottomColor = 'transparent';
            }
        }
    });
}

function showSettingsSection(section) {
    // Hide all sections
    document.getElementById('settings-general').style.display = 'none';
    document.getElementById('settings-danger').style.display = 'none';
    
    // Show selected section
    document.getElementById('settings-' + section).style.display = 'block';
    
    // Update active sidebar item
    document.querySelectorAll('#settings-tab .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    event.target.closest('.nav-link').classList.add('active');
}

function updateTemplateInfo() {
    // This function can be used to update template info without saving the whole template
    const name = document.getElementById('template-name').value;
    const description = document.getElementById('template-description').value;
    const icon = document.getElementById('template-icon').value;
    
    if (!name) {
        alert('Template name is required!');
        return;
    }
    
    // Show success message
    alert('Template information updated!');
}

let currentServiceId = null;
let autoSaveTimeout = null;

function addServiceCard() {
    serviceCounter++;
    const serviceId = `service_${serviceCounter}`;
    const canvas = document.getElementById('services-canvas');
    const emptyState = document.getElementById('empty-state');
    
    // Hide empty state
    if (emptyState) {
        emptyState.style.display = 'none';
    }
    
    // Create service object
    const initialX = Math.random() * 300 + 50;
    const initialY = Math.random() * 200 + 100;
    
    services[serviceId] = {
        id: serviceId,
        name: 'New Service',
        image: '',
        cpu: 8,
        memory: 8,
        variables: {},
        networking: {
            http: false,
            tcp: false
        },
        position: {
            x: initialX,
            y: initialY
        }
    };
    
    // Create service card HTML (Railway style)
    const service = services[serviceId];
    const cardHtml = `
        <div class="service-card railway-card" 
             data-service-id="${serviceId}"
             style="left: ${service.position.x}px; top: ${service.position.y}px;">
            <button 
                type="button" 
                class="btn btn-sm btn-link text-danger p-0 btn-remove"
                onclick="removeServiceCard('${serviceId}', event)"
                title="Remove service">
                <i class="bi bi-x-lg"></i>
            </button>
            <div class="service-card-drag-handle" title="Drag to move">
                <i class="bi bi-grip-vertical"></i>
            </div>
            <div class="service-card-content" onclick="handleCardClick('${serviceId}', event)">
                <i class="bi bi-box service-card-icon"></i>
                <div class="service-card-info">
                    <div class="service-card-name">New Service</div>
                    <div class="service-card-subtitle">No image</div>
                </div>
                <div class="service-card-badge">
                    <i class="bi bi-list-ul me-1"></i>
                    <small>No config required</small>
                </div>
            </div>
        </div>
    `;
    
    canvas.insertAdjacentHTML('beforeend', cardHtml);
    
    // Make card draggable
    const cardElement = canvas.querySelector(`[data-service-id="${serviceId}"]`);
    makeCardDraggable(cardElement, serviceId);
    
    updateEmptyState();
}

function openServiceDetails(serviceId) {
    // Prevent multiple simultaneous calls
    if (isDragging) {
        return;
    }
    
    // Prevent duplicate calls
    if (currentServiceId === serviceId && document.getElementById('service-offcanvas')?.classList.contains('show')) {
        return;
    }
    
    currentServiceId = serviceId;
    const service = services[serviceId];
    
    if (!service) {
        console.error('Service not found:', serviceId);
        return;
    }
    
    // Update offcanvas header
    const nameInput = document.getElementById('offcanvas-service-name-input');
    if (nameInput) {
        nameInput.value = service.name || 'New Service';
    }
    const imageEl = document.getElementById('offcanvas-service-image');
    if (imageEl) {
        imageEl.textContent = service.image || 'No image';
    }
    
    // Update form fields
    const sourceImage = document.getElementById('service-source-image');
    if (sourceImage) {
        sourceImage.value = service.image || '';
    }
    const cpuField = document.getElementById('service-cpu');
    if (cpuField) {
        cpuField.value = service.cpu || 8;
    }
    const memoryField = document.getElementById('service-memory');
    if (memoryField) {
        memoryField.value = service.memory || 8;
    }
    
    // Update variables list
    updateVariablesList();
    
    // Highlight selected card
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    const selectedCard = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (selectedCard) {
        selectedCard.classList.add('selected');
    }
    
    // Show offcanvas
    const offcanvasEl = document.getElementById('service-offcanvas');
    if (!offcanvasEl) {
        console.error('Offcanvas element not found - make sure the template editor is fully loaded');
        return;
    }
    
    console.log('Opening offcanvas for service:', serviceId, 'Element found:', !!offcanvasEl);
    
    // Function to show offcanvas
    function showOffcanvas() {
        console.log('showOffcanvas called');
        console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
        console.log('Bootstrap.Offcanvas available:', typeof bootstrap !== 'undefined' && typeof bootstrap.Offcanvas !== 'undefined');
        
        if (typeof bootstrap !== 'undefined' && bootstrap.Offcanvas) {
            try {
                console.log('Using Bootstrap Offcanvas API');
                
                // Get or create offcanvas instance
                let offcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                if (!offcanvas) {
                    console.log('Creating new Offcanvas instance');
                    offcanvas = new bootstrap.Offcanvas(offcanvasEl, {
                        backdrop: true,
                        scroll: true
                    });
                }
                
                // Show it
                console.log('Calling offcanvas.show()');
                offcanvas.show();
                
                // Verify it's showing
                setTimeout(() => {
                    const isShowing = offcanvasEl.classList.contains('show');
                    console.log('Offcanvas showing:', isShowing);
                    if (!isShowing) {
                        console.error('Offcanvas failed to show, trying fallback');
                        showOffcanvasFallback();
                    }
                }, 200);
            } catch (e) {
                console.error('Error showing offcanvas with Bootstrap:', e);
                showOffcanvasFallback();
            }
        } else {
            console.log('Bootstrap not available, using fallback');
            showOffcanvasFallback();
        }
    }
    
    // Fallback method to show offcanvas manually
    function showOffcanvasFallback() {
        console.log('Using fallback method to show offcanvas');
        
        // Remove existing backdrop
        const existingBackdrop = document.querySelector('.offcanvas-backdrop');
        if (existingBackdrop) {
            existingBackdrop.remove();
        }
        
        // Get navbar height
        const navbar = document.querySelector('.navbar');
        const navbarHeight = navbar ? navbar.offsetHeight : 70;
        
        // Ensure offcanvas is positioned correctly
        offcanvasEl.style.position = 'fixed';
        offcanvasEl.style.top = navbarHeight + 'px';
        offcanvasEl.style.right = '0';
        offcanvasEl.style.bottom = 'auto';
        offcanvasEl.style.left = 'auto';
        offcanvasEl.style.width = '50%';
        offcanvasEl.style.maxWidth = 'none';
        offcanvasEl.style.height = `calc(100vh - ${navbarHeight}px)`;
        offcanvasEl.style.visibility = 'visible';
        offcanvasEl.style.display = 'block';
        offcanvasEl.style.zIndex = '1055';
        offcanvasEl.style.transition = 'transform 0.3s ease-in-out';
        
        // First set it off-screen
        offcanvasEl.style.transform = 'translateX(100%)';
        offcanvasEl.classList.remove('show');
        
        // Force reflow
        void offcanvasEl.offsetHeight;
        
        // Then animate it in
        setTimeout(() => {
            offcanvasEl.classList.add('show');
            offcanvasEl.style.transform = 'translateX(0)';
        }, 10);
        
        // Add body classes
        document.body.classList.add('modal-open', 'offcanvas-open');
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = '0px';
        
        // Add backdrop first
        const backdrop = document.createElement('div');
        backdrop.className = 'offcanvas-backdrop fade show';
        backdrop.style.position = 'fixed';
        backdrop.style.top = '0';
        backdrop.style.left = '0';
        backdrop.style.width = '100vw';
        backdrop.style.height = '100vh';
        backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        backdrop.style.zIndex = '1040';
        backdrop.style.transition = 'opacity 0.15s linear';
        backdrop.setAttribute('data-bs-backdrop', 'true');
        backdrop.addEventListener('click', function() {
            hideOffcanvasFallback();
        });
        document.body.appendChild(backdrop);
        
        // Force a reflow to ensure styles are applied
        offcanvasEl.offsetHeight;
        
        console.log('Fallback offcanvas should now be visible');
    }
    
    // Function to hide offcanvas (fallback)
    function hideOffcanvasFallback() {
        offcanvasEl.classList.remove('show');
        offcanvasEl.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
            offcanvasEl.style.display = 'none';
            document.body.classList.remove('modal-open', 'offcanvas-open');
            document.body.style.overflow = '';
            const backdrop = document.querySelector('.offcanvas-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }, 300); // Wait for transition
    }
    
    // Make hide function globally available for close button
    window.hideOffcanvasFallback = hideOffcanvasFallback;
    
    // Wait a bit for DOM to be ready, then show
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showOffcanvas);
    } else {
        // DOM is already ready
        setTimeout(showOffcanvas, 50);
    }
}

function updateServiceName(name) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    services[currentServiceId].name = name || 'New Service';
    updateServiceCardDisplay(currentServiceId);
    autoSaveService();
}

function autoSaveService() {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    const service = services[currentServiceId];
    
    // Update service data from form
    service.image = document.getElementById('service-source-image').value;
    service.cpu = parseInt(document.getElementById('service-cpu').value) || 8;
    service.memory = parseInt(document.getElementById('service-memory').value) || 8;
    
    // Update card display
    updateServiceCardDisplay(currentServiceId);
    
    // Auto-save with debounce
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        console.log('Auto-saving service:', service);
        // Here you can add actual save logic if needed
    }, 1000);
}

function updateServiceCardDisplay(serviceId) {
    const service = services[serviceId];
    if (!service) return;
    
    const card = document.querySelector(`[data-service-id="${serviceId}"]`);
    if (!card) return;
    
    const nameEl = card.querySelector('.service-card-name');
    const subtitleEl = card.querySelector('.service-card-subtitle');
    
    if (nameEl) nameEl.textContent = service.name || 'New Service';
    if (subtitleEl) {
        const imageText = service.image || 'No image';
        subtitleEl.textContent = imageText.length > 30 ? imageText.substring(0, 30) + '...' : imageText;
    }
}

function addVariable() {
    if (!currentServiceId) return;
    
    const key = prompt('Enter variable key:');
    if (!key) return;
    
    const value = prompt('Enter variable value:');
    
    if (!services[currentServiceId].variables) {
        services[currentServiceId].variables = {};
    }
    
    services[currentServiceId].variables[key] = value || '';
    updateVariablesList();
    autoSaveService();
}

function updateVariablesList() {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    const variables = services[currentServiceId].variables || {};
    const container = document.getElementById('variables-list-container');
    const overviewList = document.getElementById('offcanvas-variables-list');
    
    if (Object.keys(variables).length === 0) {
        if (container) container.innerHTML = '<p class="text-muted">No Service Variables</p>';
        if (overviewList) overviewList.innerHTML = '<p class="text-muted">No variables added to this service.</p>';
        return;
    }
    
    // Update variables list in Variables tab
    if (container) {
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Key</th><th>Value</th><th>Actions</th></tr></thead><tbody>';
        
        Object.keys(variables).forEach(key => {
            html += `
                <tr>
                    <td><code>${key}</code></td>
                    <td><input type="text" class="form-control form-control-sm" value="${variables[key]}" onchange="updateVariable('${key}', this.value)"></td>
                    <td><button class="btn btn-sm btn-link text-danger" onclick="removeVariable('${key}')"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    // Update overview list
    if (overviewList) {
        let html = '<div class="list-group">';
        Object.keys(variables).forEach(key => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <code>${key}</code>
                        <div class="text-muted small">${variables[key]}</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        overviewList.innerHTML = html;
    }
}

function updateVariable(key, value) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    if (!services[currentServiceId].variables) {
        services[currentServiceId].variables = {};
    }
    
    services[currentServiceId].variables[key] = value;
    autoSaveService();
}

function removeVariable(key) {
    if (!currentServiceId || !services[currentServiceId]) return;
    
    if (services[currentServiceId].variables) {
        delete services[currentServiceId].variables[key];
        updateVariablesList();
        autoSaveService();
    }
}

function toggleRawEditor() {
    const editor = document.getElementById('raw-editor-container');
    const list = document.getElementById('variables-editor');
    
    if (editor.style.display === 'none') {
        // Show raw editor with current variables
        const variables = services[currentServiceId]?.variables || {};
        document.getElementById('raw-variables-editor').value = JSON.stringify(variables, null, 2);
        editor.style.display = 'block';
        list.style.display = 'none';
    } else {
        editor.style.display = 'none';
        list.style.display = 'block';
    }
}

function saveRawVariables() {
    if (!currentServiceId) return;
    
    try {
        const rawText = document.getElementById('raw-variables-editor').value;
        const variables = JSON.parse(rawText);
        services[currentServiceId].variables = variables;
        updateVariablesList();
        toggleRawEditor();
        autoSaveService();
    } catch (e) {
        alert('Invalid JSON format');
    }
}

function addHttpProxy() {
    if (!currentServiceId) return;
    
    if (!services[currentServiceId].networking) {
        services[currentServiceId].networking = {};
    }
    services[currentServiceId].networking.http = true;
    autoSaveService();
}

function addTcpProxy() {
    if (!currentServiceId) return;
    
    if (!services[currentServiceId].networking) {
        services[currentServiceId].networking = {};
    }
    services[currentServiceId].networking.tcp = true;
    autoSaveService();
}

function showSettingsTab() {
    const settingsTab = document.getElementById('settings-tab');
    if (settingsTab) {
        const tab = new bootstrap.Tab(settingsTab);
        tab.show();
    }
}

function editServiceSource() {
    showSettingsTab();
}

function removeServiceCard(serviceId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm('Are you sure you want to remove this service?')) {
        const card = document.querySelector(`[data-service-id="${serviceId}"]`);
        if (card) {
            card.remove();
            delete services[serviceId];
            updateEmptyState();
            
            // Close offcanvas if this service was open
            if (currentServiceId === serviceId) {
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('service-offcanvas'));
                if (offcanvas) {
                    offcanvas.hide();
                }
                currentServiceId = null;
            }
        }
    }
}

function updateEmptyState() {
    const canvas = document.getElementById('services-canvas');
    const emptyState = document.getElementById('empty-state');
    const serviceCards = canvas.querySelectorAll('.service-card');
    
    if (serviceCards.length === 0 && emptyState) {
        emptyState.style.display = 'block';
    } else if (emptyState) {
        emptyState.style.display = 'none';
    }
}

function buildTemplateConfig() {
    const templateName = document.getElementById('template-name').value;
    const templateDesc = document.getElementById('template-description').value;
    
    if (!templateName) {
        alert('Template name is required! Please go to Settings tab and enter a template name.');
        return false;
    }
    
    // Get workspace ID from settings
    const workspaceId = '{{ settings.railway_workspace_id|default:"" }}';
    if (!workspaceId) {
        alert('Please configure your Railway Workspace ID in Configurations first!');
        return false;
    }
    
    // Build services config
    const servicesConfig = {};
    Object.keys(services).forEach(serviceId => {
        const service = services[serviceId];
        if (!service.name) return;
        
        const serviceConfig = {
            name: service.name,
            source: service.image ? { image: service.image } : {},
            deploy: {
                limitOverride: {
                    containers: {
                        cpu: service.cpu || 8,
                        memoryBytes: (service.memory || 8) * 1024 * 1024 * 1024
                    }
                }
            },
            networking: {
                tcpProxies: {},
                serviceDomains: {}
            }
        };
        
        // Add variables if any
        if (Object.keys(service.variables).length > 0) {
            serviceConfig.variables = {};
            Object.keys(service.variables).forEach(key => {
                serviceConfig.variables[key] = { value: service.variables[key] };
            });
        }
        
        servicesConfig[service.id || serviceId] = serviceConfig;
    });
    
    const templateConfig = {
        input: {
            serializedConfig: {
                services: servicesConfig
            },
            workspaceId: workspaceId,
            templateId: null,
            environmentId: null,
            projectId: null
        }
    };
    
    // Set form values
    document.getElementById('form-template-name').value = templateName;
    document.getElementById('form-template-description').value = templateDesc;
    document.getElementById('form-template-config').value = JSON.stringify(templateConfig);
    
    return true;
}

function saveTemplate() {
    if (!buildTemplateConfig()) {
        return;
    }
    
    const form = document.getElementById('template-form');
    if (form) {
        // Create form data
        const formData = new FormData(form);
        
        // Submit via HTMX
        htmx.ajax('POST', '{% url "accounts:settings" %}?tab=template', {
            target: '#template-content',
            swap: 'innerHTML',
            values: formData
        });
    }
}

// Calculate navbar height and set CSS variable
function setNavbarHeight() {
    const navbar = document.querySelector('.navbar');
    if (navbar) {
        const navbarHeight = navbar.offsetHeight;
        document.documentElement.style.setProperty('--navbar-height', navbarHeight + 'px');
    }
}

// Drag and drop functionality
// Variables are already declared at the top of the script

function makeCardDraggable(cardElement, serviceId) {
    const service = services[serviceId];
    if (service && service.position) {
        cardElement.style.left = service.position.x + 'px';
        cardElement.style.top = service.position.y + 'px';
    }
    
    // Store card-specific drag state
    cardDragData.set(cardElement, {
        mousedownTime: 0,
        mousedownPos: { x: 0, y: 0 },
        hasMoved: false
    });
    
    // Make drag handle draggable
    const dragHandle = cardElement.querySelector('.service-card-drag-handle');
    if (dragHandle) {
        dragHandle.addEventListener('mousedown', function(e) {
            e.stopPropagation();
            const dragData = cardDragData.get(cardElement);
            dragData.mousedownTime = Date.now();
            dragData.mousedownPos.x = e.clientX;
            dragData.mousedownPos.y = e.clientY;
            dragData.hasMoved = false;
            
            draggedElement = cardElement;
            isDragging = false;
            
            const rect = cardElement.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            dragStartPos.x = e.clientX;
            dragStartPos.y = e.clientY;
        });
    }
    
    // Also allow dragging from the card itself, but track it
    cardElement.addEventListener('mousedown', function(e) {
        // Don't start drag if clicking on remove button or content area
        if (e.target.closest('.btn-remove') || e.target.closest('.service-card-content')) {
            return;
        }
        
        const dragData = cardDragData.get(cardElement);
        dragData.mousedownTime = Date.now();
        dragData.mousedownPos.x = e.clientX;
        dragData.mousedownPos.y = e.clientY;
        dragData.hasMoved = false;
        
        draggedElement = cardElement;
        isDragging = false;
        
        const rect = cardElement.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        dragStartPos.x = e.clientX;
        dragStartPos.y = e.clientY;
    });
    
    // Content area already has onclick handler from HTML
}

// Cache for drag performance
let canvasRectCache = null;
let cardSizeCache = { width: 0, height: 0 };
let basePosition = { x: 0, y: 0 };

// Global mouse move handler for dragging - optimized for smoothness
function handleMouseMove(e) {
    if (!draggedElement) return;
    
    const deltaX = Math.abs(e.clientX - dragStartPos.x);
    const deltaY = Math.abs(e.clientY - dragStartPos.y);
    
    // Check if movement exceeds threshold
    if (!isDragging && (deltaX > dragThreshold || deltaY > dragThreshold)) {
        isDragging = true;
        draggedElement.classList.add('dragging');
        
        // Store base position when drag starts
        basePosition.x = parseFloat(draggedElement.style.left) || 0;
        basePosition.y = parseFloat(draggedElement.style.top) || 0;
        
        // Cache canvas rect and card size once when drag starts
        const canvas = document.getElementById('services-canvas');
        if (canvas) {
            canvasRectCache = canvas.getBoundingClientRect();
            cardSizeCache.width = draggedElement.offsetWidth;
            cardSizeCache.height = draggedElement.offsetHeight;
        }
        
        // Mark that this card has moved - prevent click
        const dragData = cardDragData.get(draggedElement);
        if (dragData) {
            dragData.hasMoved = true;
        }
        
        // Disable click when dragging starts
        const cardContent = draggedElement.querySelector('.service-card-content');
        if (cardContent) {
            cardContent.dataset.dragging = 'true';
        }
    }
    
    if (!isDragging) return;
    
    e.preventDefault();
    
    if (!canvasRectCache) return;
    
    // Calculate new position relative to canvas
    let newX = e.clientX - canvasRectCache.left - dragOffset.x;
    let newY = e.clientY - canvasRectCache.top - dragOffset.y;
    
    // Constrain to canvas bounds
    const maxX = canvasRectCache.width - cardSizeCache.width;
    const maxY = canvasRectCache.height - cardSizeCache.height;
    
    newX = Math.max(0, Math.min(newX, maxX));
    newY = Math.max(0, Math.min(newY, maxY));
    
    // Calculate transform offset from base position - use transform for smooth GPU-accelerated movement
    const translateX = newX - basePosition.x;
    const translateY = newY - basePosition.y;
    
    // Apply transform directly - this is GPU accelerated and smooth
    draggedElement.style.transform = `translate3d(${translateX}px, ${translateY}px, 0)`;
}

document.addEventListener('mousemove', handleMouseMove);

document.addEventListener('mouseup', function(e) {
    const wasDragging = isDragging;
    
    if (draggedElement) {
        // Finalize position - update left/top and clear transform
        if (wasDragging) {
            const canvas = document.getElementById('services-canvas');
            if (canvas && canvasRectCache) {
                // Calculate final position
                let finalX = e.clientX - canvasRectCache.left - dragOffset.x;
                let finalY = e.clientY - canvasRectCache.top - dragOffset.y;
                
                // Constrain to canvas bounds
                const maxX = canvasRectCache.width - cardSizeCache.width;
                const maxY = canvasRectCache.height - cardSizeCache.height;
                
                finalX = Math.max(0, Math.min(finalX, maxX));
                finalY = Math.max(0, Math.min(finalY, maxY));
                
                // Update base position and clear transform
                draggedElement.style.left = finalX + 'px';
                draggedElement.style.top = finalY + 'px';
                draggedElement.style.transform = '';
                
                // Update service position
                const serviceId = draggedElement.getAttribute('data-service-id');
                if (serviceId && services[serviceId]) {
                    services[serviceId].position = { x: finalX, y: finalY };
                }
            }
        }
        
        // Clean up drag state
        const cardContent = draggedElement.querySelector('.service-card-content');
        if (cardContent) {
            delete cardContent.dataset.dragging;
        }
        
        draggedElement.classList.remove('dragging');
        
        // Clear caches
        canvasRectCache = null;
        cardSizeCache = { width: 0, height: 0 };
        basePosition = { x: 0, y: 0 };
        
        // If we were dragging, mark it so click doesn't fire
        if (wasDragging) {
            const dragData = cardDragData.get(draggedElement);
            if (dragData) {
                dragData.hasMoved = true;
            }
        } else {
            // If we weren't dragging, reset so click can work
            const dragData = cardDragData.get(draggedElement);
            if (dragData) {
                dragData.hasMoved = false;
            }
        }
        
        // Clear dragged element after a small delay to allow click
        setTimeout(() => {
            draggedElement = null;
            isDragging = false;
        }, 100);
    } else {
        isDragging = false;
    }
});

// This function is already defined above - this is just to ensure it's available

// Initialize empty state on load and hide sidebar
document.addEventListener('DOMContentLoaded', function() {
    setNavbarHeight();
    updateEmptyState();
    hideSidebar();
    
    // Recalculate navbar height on resize
    window.addEventListener('resize', setNavbarHeight);
    
    // Make existing cards draggable (if any)
    document.querySelectorAll('.service-card').forEach(card => {
        const serviceId = card.getAttribute('data-service-id');
        if (serviceId) {
            makeCardDraggable(card, serviceId);
        }
    });
    
    // Make sure functions are globally accessible
    window.openServiceDetails = openServiceDetails;
    window.handleCardClick = handleCardClick;
    window.removeServiceCard = removeServiceCard;
    window.addServiceCard = addServiceCard;
    window.addVariable = addVariable;
    window.updateVariable = updateVariable;
    window.removeVariable = removeVariable;
    window.toggleRawEditor = toggleRawEditor;
    window.saveRawVariables = saveRawVariables;
    window.addHttpProxy = addHttpProxy;
    window.addTcpProxy = addTcpProxy;
    window.showSettingsTab = showSettingsTab;
    window.editServiceSource = editServiceSource;
    window.updateServiceName = updateServiceName;
    window.autoSaveService = autoSaveService;
});

function hideSidebar() {
    const sidebar = document.querySelector('.settings-container .col-md-3');
    const mainContent = document.getElementById('main-content-wrapper');
    const settingsMainContent = document.getElementById('settings-main-content');
    const settingsContainer = document.querySelector('.settings-container');
    const mainContentContainer = document.getElementById('main-content');
    const templateContent = document.getElementById('template-content');
    
    if (sidebar) sidebar.style.display = 'none';
    if (mainContent) {
        mainContent.classList.remove('col-md-9');
        mainContent.classList.add('col-12');
        mainContent.style.padding = '0';
    }
    if (settingsMainContent) {
        settingsMainContent.style.padding = '0';
        settingsMainContent.style.height = '100%';
    }
    if (templateContent) {
        templateContent.classList.add('template-editor-mode');
        templateContent.style.height = '100%';
    }
    if (settingsContainer) {
        settingsContainer.classList.add('template-editor-mode');
    }
    if (mainContentContainer) {
        mainContentContainer.classList.add('template-editor-mode');
        mainContentContainer.style.paddingTop = '0';
        mainContentContainer.style.paddingBottom = '0';
        mainContentContainer.style.marginTop = '0';
        mainContentContainer.style.marginBottom = '0';
    }
}

// Hide sidebar immediately when template editor loads
hideSidebar();
</script>

<style>
.template-editor-full {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    display: block;
    overflow: hidden;
}

.services-canvas-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: block;
}

.add-button-container {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
}

.services-canvas {
    background-image: 
        linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 20px 20px;
    background-color: #0f0f0f;
    border-radius: 0;
    padding: 2rem;
    padding-top: 4rem;
    height: 100%;
    position: relative;
    width: 100%;
    margin: 0;
    overflow: hidden;
}

#architecture-tab {
    display: block !important;
    width: 100%;
    height: 100%;
}

.template-editor-full {
    width: 100%;
    height: 100%;
}

.service-card {
    background: #1a1a1a;
    border: 2px solid #2d2d2d;
    border-radius: 8px;
    padding: 0.75rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    cursor: grab;
    position: absolute;
    width: 180px;
    user-select: none;
    z-index: 10;
    will-change: transform;
}

.service-card:active {
    cursor: grabbing;
}

.service-card.dragging {
    transition: none;
    will-change: transform;
    pointer-events: none;
}

.service-card:hover {
    border-color: #6366f1;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.service-card.dragging {
    opacity: 0.8;
    z-index: 1000;
    cursor: grabbing;
}

.service-card.selected {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.service-card-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    cursor: pointer;
}

.service-card-icon {
    font-size: 1.25rem;
    color: #ffffff;
    margin-bottom: 0.25rem;
}

.service-card-info {
    flex: 1;
}

.service-card-name {
    color: #ffffff;
    font-weight: 600;
    font-size: 0.875rem;
    margin-bottom: 0.125rem;
}

.service-card-subtitle {
    color: #9ca3af;
    font-size: 0.75rem;
}

.service-card-badge {
    display: flex;
    align-items: center;
    color: #9ca3af;
    font-size: 0.625rem;
    margin-top: 0.25rem;
}

.service-card .btn-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 20;
    background: rgba(26, 26, 26, 0.8);
    border-radius: 4px;
    padding: 0.25rem;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.service-card-drag-handle {
    position: absolute;
    top: 0.25rem;
    left: 0.25rem;
    color: #6c757d;
    font-size: 0.875rem;
    opacity: 0.5;
    z-index: 15;
    cursor: grab;
}

.service-card:hover .service-card-drag-handle {
    opacity: 1;
}

.service-card.dragging .service-card-drag-handle {
    opacity: 1;
    color: #6366f1;
}

.service-card:hover .btn-remove {
    opacity: 1;
}

.service-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e9ecef;
}

.service-icon {
    font-size: 1.5rem;
    color: #6c757d;
}

.service-card-body {
    padding-top: 0.5rem;
}

.service-config-info {
    display: flex;
    align-items: center;
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

#empty-state {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    color: #ffffff;
    pointer-events: none;
    z-index: 1;
}

#empty-state .text-muted {
    color: #9ca3af !important;
}

.offcanvas {
    background-color: var(--white);
    color: var(--black);
    width: 50% !important;
    max-width: none !important;
    height: calc(100vh - var(--navbar-height, 70px)) !important;
    position: fixed !important;
    top: var(--navbar-height, 70px) !important;
    right: 0 !important;
    bottom: auto !important;
    left: auto !important;
    z-index: 1055 !important;
    transform: translateX(100%) !important;
    transition: transform 0.3s ease-in-out !important;
    border-left: 1px solid var(--gray-200);
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
}

.offcanvas.show {
    transform: translateX(0) !important;
}

.offcanvas-header {
    background-color: var(--white);
    border-bottom: 1px solid var(--gray-200) !important;
    padding: 1.5rem 1.5rem 1.25rem 1.5rem;
    min-height: 70px;
}

.offcanvas-title-input {
    background-color: var(--white);
    border: 1px solid var(--gray-300);
    border-radius: 0;
    color: var(--black);
    font-size: 1.25rem;
    font-weight: 600;
    padding: 0.5rem 0.75rem;
    width: 100%;
    min-width: 200px;
    transition: all 0.2s;
    font-family: 'Space Grotesk', sans-serif;
}

.offcanvas-title-input:not(.editing) {
    border-color: transparent;
    background-color: transparent;
    padding-left: 0;
    padding-right: 0;
    cursor: pointer;
}

.offcanvas-title-input:not(.editing):hover {
    border-bottom: 1px dashed var(--gray-300);
    padding-bottom: 0.25rem;
}

.offcanvas-title-input.editing {
    border-color: var(--black);
    background-color: var(--white);
    padding: 0.5rem 0.75rem;
}

.offcanvas-title-input:focus {
    outline: none;
    border-color: var(--black);
    background-color: var(--white);
    box-shadow: 0 0 0 1px var(--black);
}

.offcanvas-body {
    background-color: var(--white);
    overflow-y: auto;
    max-height: calc(100vh - var(--navbar-height, 70px) - 70px);
    color: var(--black);
    padding: 0;
}

.nav-tabs {
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 0;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
    gap: 0.5rem;
}

.nav-tabs .nav-item {
    margin-bottom: -1px;
}

.nav-tabs .nav-link {
    color: var(--gray-700);
    border-color: transparent;
    padding: 0.75rem 1rem;
    border-radius: 0;
    transition: all 0.2s;
    font-weight: 400;
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    color: var(--black);
    background-color: var(--gray-50);
}

.nav-tabs .nav-link.active {
    color: var(--black);
    background-color: transparent;
    border-color: var(--gray-200) var(--gray-200) transparent;
    border-bottom-color: var(--white) !important;
    font-weight: 500;
    border-bottom-width: 2px;
}

.tab-content {
    color: var(--black);
    min-height: 400px;
}

#service-offcanvas h6 {
    color: var(--black);
    font-weight: 600;
    font-size: 0.9375rem;
    letter-spacing: -0.01em;
}

#service-offcanvas h6 i {
    color: var(--gray-600);
}

#service-offcanvas .card {
    border-radius: 0;
}

#service-offcanvas .card-body {
    padding: 1.5rem;
}

#service-offcanvas .form-control, 
#service-offcanvas .form-select {
    background-color: var(--white);
    border: 1px solid var(--gray-300);
    color: var(--black);
    border-radius: 0;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: border-color 0.2s;
}

#service-offcanvas .form-control:focus, 
#service-offcanvas .form-select:focus {
    background-color: var(--white);
    border-color: var(--black);
    color: var(--black);
    box-shadow: none;
    outline: none;
}

#service-offcanvas .form-label {
    font-weight: 500;
    color: var(--black);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    display: block;
}

#service-offcanvas .form-text {
    color: var(--gray-600);
    font-size: 0.8125rem;
    margin-top: 0.5rem;
}

.card {
    background-color: var(--white);
    border: 1px solid var(--gray-200);
}

.table {
    color: var(--black);
}

.table thead th {
    border-color: var(--gray-200);
    color: var(--gray-700);
    font-weight: 500;
}

.table tbody td {
    border-color: var(--gray-200);
}

.settings-section {
    max-width: 600px;
}

/* Offcanvas specific button styles */
#service-offcanvas .btn-primary {
    background-color: var(--black);
    border-color: var(--black);
    color: var(--white);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

#service-offcanvas .btn-primary:hover {
    background-color: var(--gray-900);
    border-color: var(--gray-900);
    color: var(--white);
}

#service-offcanvas .btn-outline-secondary {
    border-color: var(--gray-300);
    color: var(--black);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

#service-offcanvas .btn-outline-secondary:hover {
    background-color: var(--gray-200);
    border-color: var(--gray-300);
    color: var(--black);
}

#service-offcanvas .btn-outline-primary {
    border-color: var(--black);
    color: var(--black);
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
}

#service-offcanvas .btn-outline-primary:hover {
    background-color: var(--black);
    border-color: var(--black);
    color: var(--white);
}

#service-offcanvas .btn-sm {
    padding: 0.5rem 0.875rem;
    font-size: 0.8125rem;
}

#service-offcanvas .service-offcanvas-icon {
    color: var(--black);
}

#service-offcanvas .gap-2 {
    gap: 0.75rem !important;
}

/* Better spacing utilities for offcanvas */
#service-offcanvas .mb-4 {
    margin-bottom: 2rem !important;
}

#service-offcanvas .mb-5 {
    margin-bottom: 3rem !important;
}

#service-offcanvas .mb-3 {
    margin-bottom: 1.5rem !important;
}

@media (max-width: 768px) {
    .services-canvas {
        grid-template-columns: 1fr;
    }
    
    .offcanvas {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    #service-offcanvas .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }
    
    #service-offcanvas .row > * {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}
</style>
